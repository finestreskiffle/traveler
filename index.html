<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Travel Manager">
    <meta name="theme-color" content="#007AFF">
    <title>Travel Manager</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-primary: #F2F2F7;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: rgba(255, 255, 255, 0.8);
            --text-primary: #000000;
            --text-secondary: #3C3C43;
            --text-tertiary: #8E8E93;
            --accent: #007AFF;
            --accent-secondary: #5856D6;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --separator: rgba(60, 60, 67, 0.1);
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        [data-theme="dark"] {
            --bg-primary: #000000;
            --bg-secondary: #1C1C1E;
            --bg-tertiary: rgba(28, 28, 30, 0.8);
            --text-primary: #FFFFFF;
            --text-secondary: #EBEBF5;
            --text-tertiary: #8E8E93;
            --separator: rgba(84, 84, 88, 0.6);
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            --glass-bg: rgba(28, 28, 30, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            transition: background 0.3s ease, color 0.3s ease;
        }

        #root {
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Utility functions
        const parseCSV = (csvText) => {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(';').map(h => h.trim());
            const trips = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(';');
                const trip = {};
                headers.forEach((header, index) => {
                    trip[header] = values[index]?.trim() || '';
                });
                trips.push(trip);
            }
            return trips;
        };

        const generateCSV = (trips) => {
            if (trips.length === 0) return '';
            const headers = ['Data', 'Orario Partenza', 'Orario Arrivo', 'Mezzo', 'Costo Mezzo', 'Luogo', 'Descrizione', 'Costi Vari', 'Maps'];
            const lines = [headers.join(';')];
            
            trips.forEach(trip => {
                const values = headers.map(h => trip[h] || '');
                lines.push(values.join(';'));
            });
            
            return lines.join('\n');
        };

        const groupByDate = (trips) => {
            const groups = {};
            trips.forEach(trip => {
                const date = trip.Data || 'Senza data';
                if (!groups[date]) groups[date] = [];
                groups[date].push(trip);
            });
            return groups;
        };

        const calculateDayCosts = (trips) => {
            let total = 0;
            trips.forEach(trip => {
                const costoMezzo = parseFloat(trip['Costo Mezzo']) || 0;
                const costiVari = parseFloat(trip['Costi Vari']) || 0;
                total += costoMezzo + costiVari;
            });
            return total;
        };

        const formatTime = (time) => {
            if (!time || time === '-' || time === '') return 'N/D';
            return time;
        };

        // Components
        const Icon = ({ name, size = 24 }) => {
            const icons = {
                chevronLeft: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 18l-6-6 6-6"/></svg>,
                chevronRight: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18l6-6-6-6"/></svg>,
                settings: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
                home: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
                wallet: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>,
                plus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
                trash: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
                edit: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
                map: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>,
                upload: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
                download: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
                sun: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>,
                moon: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>,
                arrowUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>,
                arrowDown: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>,
                check: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
                x: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            };
            return icons[name] || null;
        };

        const App = () => {
            const [trips, setTrips] = useState([]);
            const [currentPage, setCurrentPage] = useState('home');
            const [currentDateIndex, setCurrentDateIndex] = useState(0);
            const [darkMode, setDarkMode] = useState(false);
            const [editingTrip, setEditingTrip] = useState(null);
            const [showAddModal, setShowAddModal] = useState(false);
            const fileInputRef = useRef(null);

            // Load from localStorage
            useEffect(() => {
                const savedTrips = localStorage.getItem('travelManagerTrips');
                const savedDarkMode = localStorage.getItem('travelManagerDarkMode');
                
                if (savedTrips) {
                    setTrips(JSON.parse(savedTrips));
                }
                if (savedDarkMode) {
                    setDarkMode(JSON.parse(savedDarkMode));
                }
            }, []);

            // Save to localStorage
            useEffect(() => {
                localStorage.setItem('travelManagerTrips', JSON.stringify(trips));
            }, [trips]);

            useEffect(() => {
                localStorage.setItem('travelManagerDarkMode', JSON.stringify(darkMode));
                document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light');
            }, [darkMode]);

            const groupedTrips = groupByDate(trips);
            const dates = Object.keys(groupedTrips);

            const handleImportCSV = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const parsedTrips = parseCSV(e.target.result);
                        setTrips(parsedTrips);
                        setCurrentDateIndex(0);
                    };
                    reader.readAsText(file);
                }
            };

            const handleExportCSV = () => {
                const csv = generateCSV(trips);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'viaggio.csv';
                link.click();
                URL.revokeObjectURL(url);
            };

            const handleDeleteTrip = (tripIndex) => {
                const newTrips = trips.filter((_, index) => index !== tripIndex);
                setTrips(newTrips);
            };

            const handleSaveTrip = (tripData, originalIndex = null) => {
                if (originalIndex !== null) {
                    const newTrips = [...trips];
                    newTrips[originalIndex] = tripData;
                    setTrips(newTrips);
                } else {
                    setTrips([...trips, tripData]);
                }
                setEditingTrip(null);
                setShowAddModal(false);
            };

            const handleMoveTrip = (tripIndex, direction) => {
                const newTrips = [...trips];
                const newIndex = tripIndex + direction;
                if (newIndex >= 0 && newIndex < newTrips.length) {
                    [newTrips[tripIndex], newTrips[newIndex]] = [newTrips[newIndex], newTrips[tripIndex]];
                    setTrips(newTrips);
                }
            };

            const getTripIndex = (date, localIndex) => {
                let globalIndex = 0;
                for (const d of dates) {
                    if (d === date) {
                        return globalIndex + localIndex;
                    }
                    globalIndex += groupedTrips[d].length;
                }
                return -1;
            };

            const styles = {
                container: {
                    maxWidth: '500px',
                    margin: '0 auto',
                    minHeight: '100vh',
                    display: 'flex',
                    flexDirection: 'column',
                    background: 'var(--bg-primary)',
                },
                header: {
                    position: 'sticky',
                    top: 0,
                    zIndex: 100,
                    background: 'var(--glass-bg)',
                    backdropFilter: 'blur(20px)',
                    WebkitBackdropFilter: 'blur(20px)',
                    borderBottom: '1px solid var(--separator)',
                    padding: '16px 20px',
                },
                headerTitle: {
                    fontSize: '28px',
                    fontWeight: '700',
                    color: 'var(--text-primary)',
                    marginBottom: '4px',
                },
                headerSubtitle: {
                    fontSize: '14px',
                    color: 'var(--text-tertiary)',
                },
                content: {
                    flex: 1,
                    padding: '16px 20px',
                    paddingBottom: '100px',
                },
                dateNav: {
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    marginBottom: '20px',
                    padding: '12px 16px',
                    background: 'var(--bg-secondary)',
                    borderRadius: '16px',
                    boxShadow: 'var(--shadow)',
                },
                dateNavButton: {
                    width: '44px',
                    height: '44px',
                    borderRadius: '12px',
                    border: 'none',
                    background: 'var(--accent)',
                    color: 'white',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    cursor: 'pointer',
                    transition: 'transform 0.2s, opacity 0.2s',
                },
                dateNavButtonDisabled: {
                    opacity: 0.3,
                    cursor: 'not-allowed',
                },
                dateText: {
                    fontSize: '18px',
                    fontWeight: '600',
                    color: 'var(--text-primary)',
                },
                card: {
                    background: 'var(--bg-secondary)',
                    borderRadius: '16px',
                    padding: '16px',
                    marginBottom: '12px',
                    boxShadow: 'var(--shadow)',
                },
                cardHeader: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'flex-start',
                    marginBottom: '12px',
                },
                cardTitle: {
                    fontSize: '17px',
                    fontWeight: '600',
                    color: 'var(--text-primary)',
                    flex: 1,
                },
                cardActions: {
                    display: 'flex',
                    gap: '8px',
                },
                actionButton: {
                    width: '32px',
                    height: '32px',
                    borderRadius: '8px',
                    border: 'none',
                    background: 'var(--bg-primary)',
                    color: 'var(--text-secondary)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    cursor: 'pointer',
                },
                cardRow: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: '8px 0',
                    borderBottom: '1px solid var(--separator)',
                },
                cardRowLast: {
                    borderBottom: 'none',
                },
                cardLabel: {
                    fontSize: '13px',
                    color: 'var(--text-tertiary)',
                    fontWeight: '500',
                },
                cardValue: {
                    fontSize: '15px',
                    color: 'var(--text-primary)',
                    textAlign: 'right',
                    maxWidth: '60%',
                    wordBreak: 'break-word',
                },
                mapLink: {
                    color: 'var(--accent)',
                    textDecoration: 'none',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '4px',
                },
                dayCost: {
                    background: 'linear-gradient(135deg, var(--accent), var(--accent-secondary))',
                    borderRadius: '12px',
                    padding: '16px',
                    marginTop: '20px',
                    color: 'white',
                    textAlign: 'center',
                },
                dayCostLabel: {
                    fontSize: '13px',
                    opacity: 0.9,
                    marginBottom: '4px',
                },
                dayCostValue: {
                    fontSize: '24px',
                    fontWeight: '700',
                },
                tabBar: {
                    position: 'fixed',
                    bottom: 0,
                    left: 0,
                    right: 0,
                    background: 'var(--glass-bg)',
                    backdropFilter: 'blur(20px)',
                    WebkitBackdropFilter: 'blur(20px)',
                    borderTop: '1px solid var(--separator)',
                    display: 'flex',
                    justifyContent: 'space-around',
                    padding: '8px 0',
                    paddingBottom: 'calc(8px + env(safe-area-inset-bottom))',
                },
                tabButton: {
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    gap: '4px',
                    padding: '8px 16px',
                    border: 'none',
                    background: 'transparent',
                    color: 'var(--text-tertiary)',
                    cursor: 'pointer',
                    fontSize: '11px',
                    fontWeight: '500',
                },
                tabButtonActive: {
                    color: 'var(--accent)',
                },
                settingsItem: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: '16px',
                    background: 'var(--bg-secondary)',
                    borderRadius: '12px',
                    marginBottom: '12px',
                },
                settingsLabel: {
                    fontSize: '16px',
                    color: 'var(--text-primary)',
                },
                toggle: {
                    width: '51px',
                    height: '31px',
                    borderRadius: '16px',
                    border: 'none',
                    cursor: 'pointer',
                    position: 'relative',
                    transition: 'background 0.3s',
                },
                toggleThumb: {
                    width: '27px',
                    height: '27px',
                    borderRadius: '14px',
                    background: 'white',
                    position: 'absolute',
                    top: '2px',
                    transition: 'left 0.3s',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.2)',
                },
                button: {
                    width: '100%',
                    padding: '16px',
                    borderRadius: '12px',
                    border: 'none',
                    fontSize: '16px',
                    fontWeight: '600',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px',
                    marginBottom: '12px',
                },
                primaryButton: {
                    background: 'var(--accent)',
                    color: 'white',
                },
                secondaryButton: {
                    background: 'var(--bg-secondary)',
                    color: 'var(--accent)',
                },
                fab: {
                    position: 'fixed',
                    bottom: '100px',
                    right: '20px',
                    width: '56px',
                    height: '56px',
                    borderRadius: '28px',
                    border: 'none',
                    background: 'var(--accent)',
                    color: 'white',
                    boxShadow: '0 4px 12px rgba(0, 122, 255, 0.4)',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                },
                modal: {
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    alignItems: 'flex-end',
                    justifyContent: 'center',
                    zIndex: 1000,
                },
                modalContent: {
                    background: 'var(--bg-primary)',
                    borderRadius: '24px 24px 0 0',
                    width: '100%',
                    maxWidth: '500px',
                    maxHeight: '90vh',
                    overflow: 'auto',
                    padding: '20px',
                    paddingBottom: 'calc(20px + env(safe-area-inset-bottom))',
                },
                modalHeader: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '20px',
                },
                modalTitle: {
                    fontSize: '20px',
                    fontWeight: '600',
                    color: 'var(--text-primary)',
                },
                input: {
                    width: '100%',
                    padding: '14px 16px',
                    borderRadius: '12px',
                    border: '1px solid var(--separator)',
                    background: 'var(--bg-secondary)',
                    color: 'var(--text-primary)',
                    fontSize: '16px',
                    marginBottom: '12px',
                    outline: 'none',
                },
                inputLabel: {
                    fontSize: '13px',
                    color: 'var(--text-tertiary)',
                    marginBottom: '6px',
                    display: 'block',
                },
                totalCard: {
                    background: 'var(--bg-secondary)',
                    borderRadius: '16px',
                    padding: '20px',
                    marginBottom: '16px',
                },
                totalRow: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: '12px 0',
                    borderBottom: '1px solid var(--separator)',
                },
                emptyState: {
                    textAlign: 'center',
                    padding: '60px 20px',
                    color: 'var(--text-tertiary)',
                },
                emptyStateIcon: {
                    marginBottom: '16px',
                    opacity: 0.5,
                },
                emptyStateText: {
                    fontSize: '16px',
                    marginBottom: '8px',
                },
                emptyStateSubtext: {
                    fontSize: '14px',
                    opacity: 0.7,
                },
            };

            // Trip Edit Modal
            const TripModal = ({ trip, onSave, onClose, isNew }) => {
                const [formData, setFormData] = useState(trip || {
                    'Data': '',
                    'Orario Partenza': '',
                    'Orario Arrivo': '',
                    'Mezzo': '',
                    'Costo Mezzo': '',
                    'Luogo': '',
                    'Descrizione': '',
                    'Costi Vari': '',
                    'Maps': ''
                });

                const handleChange = (field, value) => {
                    setFormData({ ...formData, [field]: value });
                };

                return (
                    <div style={styles.modal} onClick={onClose}>
                        <div style={styles.modalContent} onClick={e => e.stopPropagation()}>
                            <div style={styles.modalHeader}>
                                <h2 style={styles.modalTitle}>{isNew ? 'Nuova Tappa' : 'Modifica Tappa'}</h2>
                                <button style={styles.actionButton} onClick={onClose}>
                                    <Icon name="x" size={20} />
                                </button>
                            </div>
                            
                            <label style={styles.inputLabel}>Data</label>
                            <input
                                style={styles.input}
                                value={formData['Data']}
                                onChange={e => handleChange('Data', e.target.value)}
                                placeholder="es. 27/11 o 27/11/2024"
                            />
                            
                            <label style={styles.inputLabel}>Orario Partenza</label>
                            <input
                                style={styles.input}
                                value={formData['Orario Partenza']}
                                onChange={e => handleChange('Orario Partenza', e.target.value)}
                                placeholder="es. 9:45"
                            />
                            
                            <label style={styles.inputLabel}>Orario Arrivo</label>
                            <input
                                style={styles.input}
                                value={formData['Orario Arrivo']}
                                onChange={e => handleChange('Orario Arrivo', e.target.value)}
                                placeholder="es. 11:15"
                            />
                            
                            <label style={styles.inputLabel}>Mezzo</label>
                            <input
                                style={styles.input}
                                value={formData['Mezzo']}
                                onChange={e => handleChange('Mezzo', e.target.value)}
                                placeholder="es. Piedi, Treno, Aereo"
                            />
                            
                            <label style={styles.inputLabel}>Costo Mezzo (€)</label>
                            <input
                                style={styles.input}
                                type="number"
                                value={formData['Costo Mezzo']}
                                onChange={e => handleChange('Costo Mezzo', e.target.value)}
                                placeholder="0"
                            />
                            
                            <label style={styles.inputLabel}>Luogo</label>
                            <input
                                style={styles.input}
                                value={formData['Luogo']}
                                onChange={e => handleChange('Luogo', e.target.value)}
                                placeholder="Nome del luogo"
                            />
                            
                            <label style={styles.inputLabel}>Descrizione</label>
                            <input
                                style={styles.input}
                                value={formData['Descrizione']}
                                onChange={e => handleChange('Descrizione', e.target.value)}
                                placeholder="Descrizione attività"
                            />
                            
                            <label style={styles.inputLabel}>Costi Vari (€)</label>
                            <input
                                style={styles.input}
                                type="number"
                                value={formData['Costi Vari']}
                                onChange={e => handleChange('Costi Vari', e.target.value)}
                                placeholder="0"
                            />
                            
                            <label style={styles.inputLabel}>Link Google Maps</label>
                            <input
                                style={styles.input}
                                value={formData['Maps']}
                                onChange={e => handleChange('Maps', e.target.value)}
                                placeholder="https://maps.app.goo.gl/..."
                            />
                            
                            <button
                                style={{ ...styles.button, ...styles.primaryButton, marginTop: '8px' }}
                                onClick={() => onSave(formData)}
                            >
                                <Icon name="check" size={20} />
                                Salva
                            </button>
                        </div>
                    </div>
                );
            };

            // Home Page
            const HomePage = () => (
                <>
                    <div style={styles.header}>
                        <h1 style={styles.headerTitle}>Il Mio Viaggio</h1>
                        <p style={styles.headerSubtitle}>
                            {trips.length} {trips.length === 1 ? 'tappa' : 'tappe'} totali
                        </p>
                    </div>
                    
                    <div style={styles.content}>
                        {dates.length === 0 ? (
                            <div style={styles.emptyState}>
                                <div style={styles.emptyStateIcon}>
                                    <Icon name="map" size={48} />
                                </div>
                                <p style={styles.emptyStateText}>Nessun viaggio caricato</p>
                                <p style={styles.emptyStateSubtext}>
                                    Vai nelle impostazioni per importare un file CSV
                                </p>
                            </div>
                        ) : (
                            <>
                                <div style={styles.dateNav}>
                                    <button
                                        style={{
                                            ...styles.dateNavButton,
                                            ...(currentDateIndex === 0 ? styles.dateNavButtonDisabled : {})
                                        }}
                                        onClick={() => setCurrentDateIndex(Math.max(0, currentDateIndex - 1))}
                                        disabled={currentDateIndex === 0}
                                    >
                                        <Icon name="chevronLeft" size={20} />
                                    </button>
                                    <span style={styles.dateText}>{dates[currentDateIndex]}</span>
                                    <button
                                        style={{
                                            ...styles.dateNavButton,
                                            ...(currentDateIndex === dates.length - 1 ? styles.dateNavButtonDisabled : {})
                                        }}
                                        onClick={() => setCurrentDateIndex(Math.min(dates.length - 1, currentDateIndex + 1))}
                                        disabled={currentDateIndex === dates.length - 1}
                                    >
                                        <Icon name="chevronRight" size={20} />
                                    </button>
                                </div>

                                {groupedTrips[dates[currentDateIndex]]?.map((trip, localIndex) => {
                                    const globalIndex = getTripIndex(dates[currentDateIndex], localIndex);
                                    return (
                                        <div key={localIndex} style={styles.card}>
                                            <div style={styles.cardHeader}>
                                                <h3 style={styles.cardTitle}>{trip.Luogo || 'Senza nome'}</h3>
                                                <div style={styles.cardActions}>
                                                    <button
                                                        style={styles.actionButton}
                                                        onClick={() => handleMoveTrip(globalIndex, -1)}
                                                    >
                                                        <Icon name="arrowUp" size={16} />
                                                    </button>
                                                    <button
                                                        style={styles.actionButton}
                                                        onClick={() => handleMoveTrip(globalIndex, 1)}
                                                    >
                                                        <Icon name="arrowDown" size={16} />
                                                    </button>
                                                    <button
                                                        style={styles.actionButton}
                                                        onClick={() => setEditingTrip({ data: trip, index: globalIndex })}
                                                    >
                                                        <Icon name="edit" size={16} />
                                                    </button>
                                                    <button
                                                        style={{ ...styles.actionButton, color: 'var(--danger)' }}
                                                        onClick={() => handleDeleteTrip(globalIndex)}
                                                    >
                                                        <Icon name="trash" size={16} />
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div style={styles.cardRow}>
                                                <span style={styles.cardLabel}>Partenza</span>
                                                <span style={styles.cardValue}>{formatTime(trip['Orario Partenza'])}</span>
                                            </div>
                                            <div style={styles.cardRow}>
                                                <span style={styles.cardLabel}>Arrivo</span>
                                                <span style={styles.cardValue}>{formatTime(trip['Orario Arrivo'])}</span>
                                            </div>
                                            {trip.Mezzo && (
                                                <div style={styles.cardRow}>
                                                    <span style={styles.cardLabel}>Mezzo</span>
                                                    <span style={styles.cardValue}>{trip.Mezzo}</span>
                                                </div>
                                            )}
                                            {trip.Descrizione && (
                                                <div style={styles.cardRow}>
                                                    <span style={styles.cardLabel}>Descrizione</span>
                                                    <span style={styles.cardValue}>{trip.Descrizione}</span>
                                                </div>
                                            )}
                                            {(trip['Costo Mezzo'] || trip['Costi Vari']) && (
                                                <div style={styles.cardRow}>
                                                    <span style={styles.cardLabel}>Costi</span>
                                                    <span style={styles.cardValue}>
                                                        €{((parseFloat(trip['Costo Mezzo']) || 0) + (parseFloat(trip['Costi Vari']) || 0)).toFixed(2)}
                                                    </span>
                                                </div>
                                            )}
                                            {trip.Maps && (
                                                <div style={{ ...styles.cardRow, ...styles.cardRowLast }}>
                                                    <span style={styles.cardLabel}>Posizione</span>
                                                    <a
                                                        href={trip.Maps}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        style={styles.mapLink}
                                                    >
                                                        <Icon name="map" size={16} />
                                                        Apri Maps
                                                    </a>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}

                                <div style={styles.dayCost}>
                                    <p style={styles.dayCostLabel}>Costo giornata</p>
                                    <p style={styles.dayCostValue}>
                                        €{calculateDayCosts(groupedTrips[dates[currentDateIndex]]).toFixed(2)}
                                    </p>
                                </div>
                            </>
                        )}
                    </div>

                    <button style={styles.fab} onClick={() => setShowAddModal(true)}>
                        <Icon name="plus" size={24} />
                    </button>
                </>
            );

            // Costs Page
            const CostsPage = () => {
                const totalCosts = trips.reduce((acc, trip) => {
                    return acc + (parseFloat(trip['Costo Mezzo']) || 0) + (parseFloat(trip['Costi Vari']) || 0);
                }, 0);

                const totalMezzo = trips.reduce((acc, trip) => acc + (parseFloat(trip['Costo Mezzo']) || 0), 0);
                const totalVari = trips.reduce((acc, trip) => acc + (parseFloat(trip['Costi Vari']) || 0), 0);

                return (
                    <>
                        <div style={styles.header}>
                            <h1 style={styles.headerTitle}>Costi</h1>
                            <p style={styles.headerSubtitle}>Riepilogo spese viaggio</p>
                        </div>
                        
                        <div style={styles.content}>
                            <div style={styles.dayCost}>
                                <p style={styles.dayCostLabel}>Totale Viaggio</p>
                                <p style={styles.dayCostValue}>€{totalCosts.toFixed(2)}</p>
                            </div>

                            <div style={styles.totalCard}>
                                <div style={styles.totalRow}>
                                    <span style={styles.cardLabel}>Costi Mezzi</span>
                                    <span style={styles.cardValue}>€{totalMezzo.toFixed(2)}</span>
                                </div>
                                <div style={{ ...styles.totalRow, borderBottom: 'none' }}>
                                    <span style={styles.cardLabel}>Costi Vari</span>
                                    <span style={styles.cardValue}>€{totalVari.toFixed(2)}</span>
                                </div>
                            </div>

                            <h3 style={{ ...styles.cardTitle, marginBottom: '16px' }}>Per Giornata</h3>
                            {dates.map(date => (
                                <div key={date} style={styles.totalCard}>
                                    <div style={{ ...styles.totalRow, borderBottom: 'none' }}>
                                        <span style={{ ...styles.cardLabel, fontSize: '15px', color: 'var(--text-primary)' }}>{date}</span>
                                        <span style={{ ...styles.cardValue, fontWeight: '600' }}>
                                            €{calculateDayCosts(groupedTrips[date]).toFixed(2)}
                                        </span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </>
                );
            };

            // Settings Page
            const SettingsPage = () => (
                <>
                    <div style={styles.header}>
                        <h1 style={styles.headerTitle}>Impostazioni</h1>
                        <p style={styles.headerSubtitle}>Personalizza l'app</p>
                    </div>
                    
                    <div style={styles.content}>
                        <div style={styles.settingsItem}>
                            <span style={styles.settingsLabel}>Modalità scura</span>
                            <button
                                style={{
                                    ...styles.toggle,
                                    background: darkMode ? 'var(--accent)' : 'var(--separator)'
                                }}
                                onClick={() => setDarkMode(!darkMode)}
                            >
                                <div style={{
                                    ...styles.toggleThumb,
                                    left: darkMode ? '22px' : '2px'
                                }} />
                            </button>
                        </div>

                        <input
                            type="file"
                            ref={fileInputRef}
                            accept=".csv"
                            onChange={handleImportCSV}
                            style={{ display: 'none' }}
                        />
                        
                        <button
                            style={{ ...styles.button, ...styles.primaryButton }}
                            onClick={() => fileInputRef.current?.click()}
                        >
                            <Icon name="upload" size={20} />
                            Importa CSV
                        </button>
                        
                        <button
                            style={{ ...styles.button, ...styles.secondaryButton }}
                            onClick={handleExportCSV}
                            disabled={trips.length === 0}
                        >
                            <Icon name="download" size={20} />
                            Esporta CSV
                        </button>

                        {trips.length > 0 && (
                            <button
                                style={{ ...styles.button, background: 'var(--danger)', color: 'white' }}
                                onClick={() => {
                                    if (confirm('Sei sicuro di voler eliminare tutti i dati?')) {
                                        setTrips([]);
                                        setCurrentDateIndex(0);
                                    }
                                }}
                            >
                                <Icon name="trash" size={20} />
                                Elimina tutti i dati
                            </button>
                        )}
                    </div>
                </>
            );

            return (
                <div style={styles.container}>
                    {currentPage === 'home' && <HomePage />}
                    {currentPage === 'costs' && <CostsPage />}
                    {currentPage === 'settings' && <SettingsPage />}

                    {editingTrip && (
                        <TripModal
                            trip={editingTrip.data}
                            onSave={(data) => handleSaveTrip(data, editingTrip.index)}
                            onClose={() => setEditingTrip(null)}
                            isNew={false}
                        />
                    )}

                    {showAddModal && (
                        <TripModal
                            trip={null}
                            onSave={(data) => handleSaveTrip(data)}
                            onClose={() => setShowAddModal(false)}
                            isNew={true}
                        />
                    )}

                    <div style={styles.tabBar}>
                        <button
                            style={{
                                ...styles.tabButton,
                                ...(currentPage === 'home' ? styles.tabButtonActive : {})
                            }}
                            onClick={() => setCurrentPage('home')}
                        >
                            <Icon name="home" size={24} />
                            Viaggio
                        </button>
                        <button
                            style={{
                                ...styles.tabButton,
                                ...(currentPage === 'costs' ? styles.tabButtonActive : {})
                            }}
                            onClick={() => setCurrentPage('costs')}
                        >
                            <Icon name="wallet" size={24} />
                            Costi
                        </button>
                        <button
                            style={{
                                ...styles.tabButton,
                                ...(currentPage === 'settings' ? styles.tabButtonActive : {})
                            }}
                            onClick={() => setCurrentPage('settings')}
                        >
                            <Icon name="settings" size={24} />
                            Impostazioni
                        </button>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
