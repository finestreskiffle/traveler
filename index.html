<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Travel Manager">
    <meta name="theme-color" content="#007AFF">
    <title>Travel Manager</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-primary: #F2F2F7;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: rgba(255, 255, 255, 0.8);
            --text-primary: #000000;
            --text-secondary: #3C3C43;
            --text-tertiary: #8E8E93;
            --accent: #007AFF;
            --accent-secondary: #5856D6;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --separator: rgba(60, 60, 67, 0.1);
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        [data-theme="dark"] {
            --bg-primary: #000000;
            --bg-secondary: #1C1C1E;
            --bg-tertiary: rgba(28, 28, 30, 0.8);
            --text-primary: #FFFFFF;
            --text-secondary: #EBEBF5;
            --text-tertiary: #8E8E93;
            --separator: rgba(84, 84, 88, 0.6);
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            --glass-bg: rgba(28, 28, 30, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        /* Theme colors */
        [data-accent="blue"] { --accent: #007AFF; --accent-secondary: #5856D6; }
        [data-accent="purple"] { --accent: #AF52DE; --accent-secondary: #5856D6; }
        [data-accent="pink"] { --accent: #FF2D55; --accent-secondary: #FF375F; }
        [data-accent="red"] { --accent: #FF3B30; --accent-secondary: #FF6961; }
        [data-accent="orange"] { --accent: #FF9500; --accent-secondary: #FFCC00; }
        [data-accent="green"] { --accent: #34C759; --accent-secondary: #30D158; }
        [data-accent="teal"] { --accent: #5AC8FA; --accent-secondary: #64D2FF; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            transition: background 0.3s ease, color 0.3s ease;
        }

        #root {
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Constants
        const EXPENSE_CATEGORIES = [
            { id: 'trasporti', name: 'Trasporti', color: '#007AFF', icon: 'üöó' },
            { id: 'alloggio', name: 'Alloggio', color: '#5856D6', icon: 'üè®' },
            { id: 'cibo', name: 'Cibo', color: '#FF9500', icon: 'üçΩÔ∏è' },
            { id: 'attivita', name: 'Attivit√†', color: '#34C759', icon: 'üéØ' },
            { id: 'shopping', name: 'Shopping', color: '#FF2D55', icon: 'üõçÔ∏è' },
            { id: 'altro', name: 'Altro', color: '#8E8E93', icon: 'üì¶' },
        ];

        const TRANSPORT_TYPES = [
            { id: 'piedi', name: 'A piedi', icon: 'üö∂' },
            { id: 'auto', name: 'Auto', icon: 'üöó' },
            { id: 'treno', name: 'Treno', icon: 'üöÜ' },
            { id: 'aereo', name: 'Aereo', icon: '‚úàÔ∏è' },
            { id: 'bus', name: 'Bus', icon: 'üöå' },
            { id: 'metro', name: 'Metro', icon: 'üöá' },
            { id: 'taxi', name: 'Taxi', icon: 'üöï' },
            { id: 'bici', name: 'Bici', icon: 'üö¥' },
            { id: 'nave', name: 'Nave', icon: '‚õ¥Ô∏è' },
            { id: 'altro', name: 'Altro', icon: 'üöÄ' },
        ];

        const ACCENT_COLORS = [
            { id: 'blue', name: 'Blu', color: '#007AFF' },
            { id: 'purple', name: 'Viola', color: '#AF52DE' },
            { id: 'pink', name: 'Rosa', color: '#FF2D55' },
            { id: 'red', name: 'Rosso', color: '#FF3B30' },
            { id: 'orange', name: 'Arancione', color: '#FF9500' },
            { id: 'green', name: 'Verde', color: '#34C759' },
            { id: 'teal', name: 'Azzurro', color: '#5AC8FA' },
        ];

        // Utility functions
        const parseCSV = (csvText) => {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(';').map(h => h.trim());
            const trips = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(';');
                const trip = {};
                headers.forEach((header, index) => {
                    trip[header] = values[index]?.trim() || '';
                });
                if (!trip['Categoria']) trip['Categoria'] = 'altro';
                trips.push(trip);
            }
            return trips;
        };

        const generateCSV = (trips) => {
            if (trips.length === 0) return '';
            const headers = ['Data', 'Orario Partenza', 'Orario Arrivo', 'Mezzo', 'Costo Mezzo', 'Costo Pasto', 'Costo Hotel', 'Costo Attivit√†', 'Costi Vari', 'Luogo', 'Descrizione', 'Maps', 'Categoria', 'Distanza', 'Completata'];
            const lines = [headers.join(';')];
            
            trips.forEach(trip => {
                const values = headers.map(h => trip[h] || '');
                lines.push(values.join(';'));
            });
            
            return lines.join('\n');
        };

        const groupByDate = (trips) => {
            const groups = {};
            trips.forEach(trip => {
                const date = trip.Data || 'Senza data';
                if (!groups[date]) groups[date] = [];
                groups[date].push(trip);
            });
            return groups;
        };

        const formatTime = (time) => {
            if (!time || time === '-' || time === '') return 'N/D';
            return time;
        };

        const getTransportIcon = (mezzo) => {
            if (!mezzo) return 'üìç';
            const transport = TRANSPORT_TYPES.find(t => 
                mezzo.toLowerCase().includes(t.id) || 
                mezzo.toLowerCase().includes(t.name.toLowerCase())
            );
            return transport ? transport.icon : 'üìç';
        };

        const getCategoryColor = (categoryId) => {
            const cat = EXPENSE_CATEGORIES.find(c => c.id === categoryId);
            return cat ? cat.color : '#8E8E93';
        };

        // Components
        const Icon = ({ name, size = 24 }) => {
            const icons = {
                chevronLeft: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 18l-6-6 6-6"/></svg>,
                chevronRight: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18l6-6-6-6"/></svg>,
                settings: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
                home: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
                wallet: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>,
                plus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
                trash: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
                edit: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
                map: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>,
                upload: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
                download: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
                arrowUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>,
                arrowDown: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>,
                check: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
                x: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
                navigation: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>,
                pieChart: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
                search: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
                grip: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>,
            };
            return icons[name] || null;
        };

        const App = () => {
            const [trips, setTrips] = useState([]);
            const [currentPage, setCurrentPage] = useState('home');
            const [currentDateIndex, setCurrentDateIndex] = useState(0);
            const [darkMode, setDarkMode] = useState(false);
            const [editingTrip, setEditingTrip] = useState(null);
            const [showAddModal, setShowAddModal] = useState(false);
            const [tripTitle, setTripTitle] = useState('Il Mio Viaggio');
            const [currency, setCurrency] = useState('‚Ç¨');
            const [budget, setBudget] = useState(0);
            const [accentColor, setAccentColor] = useState('blue');
            const [numPersone, setNumPersone] = useState(1);
            const [moltiplicatori, setMoltiplicatori] = useState({
                'Costo Mezzo': false,
                'Costo Pasto': false,
                'Costo Hotel': false,
                'Costo Attivit√†': false,
                'Costi Vari': false
            });
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('all');
            const [draggedIndex, setDraggedIndex] = useState(null);
            const [touchStart, setTouchStart] = useState(null);
            const [touchEnd, setTouchEnd] = useState(null);
            const fileInputRef = useRef(null);
            const swipeContainerRef = useRef(null);

            const currencies = [
                { symbol: '‚Ç¨', name: 'Euro (EUR)' },
                { symbol: '$', name: 'Dollaro USA (USD)' },
                { symbol: '¬£', name: 'Sterlina (GBP)' },
                { symbol: '¬•', name: 'Yen (JPY)' },
                { symbol: '‚Ç£', name: 'Franco Svizzero (CHF)' },
                { symbol: 'C$', name: 'Dollaro Canadese (CAD)' },
                { symbol: 'A$', name: 'Dollaro Australiano (AUD)' },
                { symbol: '‚Çπ', name: 'Rupia Indiana (INR)' },
                { symbol: 'ÂÖÉ', name: 'Yuan Cinese (CNY)' },
                { symbol: '‚Ç©', name: 'Won Coreano (KRW)' },
                { symbol: 'R$', name: 'Real Brasiliano (BRL)' },
                { symbol: '‚ÇΩ', name: 'Rublo Russo (RUB)' },
                { symbol: 'kr', name: 'Corona Svedese (SEK)' },
                { symbol: 'z≈Ç', name: 'Zloty Polacco (PLN)' },
                { symbol: '‡∏ø', name: 'Baht Thailandese (THB)' },
            ];

            // Load from localStorage
            useEffect(() => {
                const savedTrips = localStorage.getItem('travelManagerTrips');
                const savedDarkMode = localStorage.getItem('travelManagerDarkMode');
                const savedTripTitle = localStorage.getItem('travelManagerTripTitle');
                const savedCurrency = localStorage.getItem('travelManagerCurrency');
                const savedBudget = localStorage.getItem('travelManagerBudget');
                const savedAccentColor = localStorage.getItem('travelManagerAccentColor');
                const savedNumPersone = localStorage.getItem('travelManagerNumPersone');
                const savedMoltiplicatori = localStorage.getItem('travelManagerMoltiplicatori');
                
                if (savedTrips) setTrips(JSON.parse(savedTrips));
                if (savedDarkMode) setDarkMode(JSON.parse(savedDarkMode));
                if (savedTripTitle) setTripTitle(savedTripTitle);
                if (savedCurrency) setCurrency(savedCurrency);
                if (savedBudget) setBudget(parseFloat(savedBudget));
                if (savedAccentColor) setAccentColor(savedAccentColor);
                if (savedNumPersone) setNumPersone(parseInt(savedNumPersone));
                if (savedMoltiplicatori) setMoltiplicatori(JSON.parse(savedMoltiplicatori));
            }, []);

            // Save to localStorage
            useEffect(() => {
                localStorage.setItem('travelManagerTrips', JSON.stringify(trips));
            }, [trips]);

            useEffect(() => {
                localStorage.setItem('travelManagerDarkMode', JSON.stringify(darkMode));
                document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light');
            }, [darkMode]);

            useEffect(() => {
                localStorage.setItem('travelManagerTripTitle', tripTitle);
            }, [tripTitle]);

            useEffect(() => {
                localStorage.setItem('travelManagerCurrency', currency);
            }, [currency]);

            useEffect(() => {
                localStorage.setItem('travelManagerBudget', budget.toString());
            }, [budget]);

            useEffect(() => {
                localStorage.setItem('travelManagerAccentColor', accentColor);
                document.documentElement.setAttribute('data-accent', accentColor);
            }, [accentColor]);

            useEffect(() => {
                localStorage.setItem('travelManagerNumPersone', numPersone.toString());
            }, [numPersone]);

            useEffect(() => {
                localStorage.setItem('travelManagerMoltiplicatori', JSON.stringify(moltiplicatori));
            }, [moltiplicatori]);

            const groupedTrips = groupByDate(trips);
            const dates = Object.keys(groupedTrips);

            // Helper to get cost with multiplier
            const getCostWithMultiplier = (trip, costField) => {
                const baseCost = parseFloat(trip[costField]) || 0;
                if (moltiplicatori[costField] && numPersone > 1) {
                    return baseCost * numPersone;
                }
                return baseCost;
            };

            // Helper to get total cost for a trip
            const getTripTotalCost = (trip) => {
                return getCostWithMultiplier(trip, 'Costo Mezzo') +
                       getCostWithMultiplier(trip, 'Costo Pasto') +
                       getCostWithMultiplier(trip, 'Costo Hotel') +
                       getCostWithMultiplier(trip, 'Costo Attivit√†') +
                       getCostWithMultiplier(trip, 'Costi Vari');
            };

            const totalCosts = trips.reduce((acc, trip) => {
                return acc + getTripTotalCost(trip);
            }, 0);

            const totalDistance = trips.reduce((acc, trip) => {
                return acc + (parseFloat(trip['Distanza']) || 0);
            }, 0);

            const handleImportCSV = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const parsedTrips = parseCSV(e.target.result);
                        setTrips(parsedTrips);
                        setCurrentDateIndex(0);
                    };
                    reader.readAsText(file);
                }
            };

            const handleExportCSV = () => {
                const csv = generateCSV(trips);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'viaggio.csv';
                link.click();
                URL.revokeObjectURL(url);
            };

            const handleDeleteTrip = (tripIndex) => {
                const newTrips = trips.filter((_, index) => index !== tripIndex);
                setTrips(newTrips);
            };

            const handleSaveTrip = (tripData, originalIndex = null) => {
                if (originalIndex !== null) {
                    const newTrips = [...trips];
                    newTrips[originalIndex] = tripData;
                    setTrips(newTrips);
                } else {
                    setTrips([...trips, tripData]);
                }
                setEditingTrip(null);
                setShowAddModal(false);
            };

            const handleMoveTrip = (tripIndex, direction) => {
                const newTrips = [...trips];
                const newIndex = tripIndex + direction;
                if (newIndex >= 0 && newIndex < newTrips.length) {
                    [newTrips[tripIndex], newTrips[newIndex]] = [newTrips[newIndex], newTrips[tripIndex]];
                    setTrips(newTrips);
                }
            };

            const handleToggleComplete = (tripIndex) => {
                const newTrips = [...trips];
                newTrips[tripIndex] = {
                    ...newTrips[tripIndex],
                    'Completata': newTrips[tripIndex]['Completata'] === 'true' ? 'false' : 'true'
                };
                setTrips(newTrips);
            };

            // Swipe handlers
            const minSwipeDistance = 50;

            const onTouchStart = (e) => {
                setTouchEnd(null);
                setTouchStart(e.targetTouches[0].clientX);
            };

            const onTouchMove = (e) => {
                setTouchEnd(e.targetTouches[0].clientX);
            };

            const onTouchEnd = () => {
                if (!touchStart || !touchEnd) return;
                const distance = touchStart - touchEnd;
                const isLeftSwipe = distance > minSwipeDistance;
                const isRightSwipe = distance < -minSwipeDistance;
                
                if (isLeftSwipe && currentDateIndex < dates.length - 1) {
                    setCurrentDateIndex(currentDateIndex + 1);
                }
                if (isRightSwipe && currentDateIndex > 0) {
                    setCurrentDateIndex(currentDateIndex - 1);
                }
            };

            // Drag & Drop handlers
            const handleDragStart = (e, index) => {
                setDraggedIndex(index);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', e.target.outerHTML);
                e.target.style.opacity = '0.5';
            };

            const handleDragEnd = (e) => {
                e.target.style.opacity = '1';
                setDraggedIndex(null);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDrop = (e, dropIndex) => {
                e.preventDefault();
                if (draggedIndex === null || draggedIndex === dropIndex) return;
                
                const newTrips = [...trips];
                const [draggedTrip] = newTrips.splice(draggedIndex, 1);
                newTrips.splice(dropIndex, 0, draggedTrip);
                setTrips(newTrips);
                setDraggedIndex(null);
            };

            // Filter trips based on search and category
            const filterTrips = (tripsToFilter) => {
                return tripsToFilter.filter(trip => {
                    const matchesSearch = searchQuery === '' || 
                        (trip.Luogo && trip.Luogo.toLowerCase().includes(searchQuery.toLowerCase())) ||
                        (trip.Descrizione && trip.Descrizione.toLowerCase().includes(searchQuery.toLowerCase()));
                    
                    const matchesCategory = selectedCategory === 'all' || trip.Categoria === selectedCategory;
                    
                    return matchesSearch && matchesCategory;
                });
            };

            const getTripIndex = (date, localIndex) => {
                let globalIndex = 0;
                for (const d of dates) {
                    if (d === date) {
                        return globalIndex + localIndex;
                    }
                    globalIndex += groupedTrips[d].length;
                }
                return -1;
            };

            const styles = {
                container: {
                    maxWidth: '500px',
                    margin: '0 auto',
                    minHeight: '100vh',
                    display: 'flex',
                    flexDirection: 'column',
                    background: 'var(--bg-primary)',
                },
                header: {
                    position: 'sticky',
                    top: 0,
                    zIndex: 100,
                    background: 'var(--glass-bg)',
                    backdropFilter: 'blur(20px)',
                    WebkitBackdropFilter: 'blur(20px)',
                    borderBottom: '1px solid var(--separator)',
                    padding: '16px 20px',
                },
                headerTitle: {
                    fontSize: '28px',
                    fontWeight: '700',
                    color: 'var(--text-primary)',
                    marginBottom: '4px',
                },
                headerSubtitle: {
                    fontSize: '14px',
                    color: 'var(--text-tertiary)',
                },
                content: {
                    flex: 1,
                    padding: '16px 20px',
                    paddingBottom: '180px',
                },
                dateNav: {
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    marginBottom: '16px',
                    padding: '12px 16px',
                    background: 'var(--bg-secondary)',
                    borderRadius: '16px',
                    boxShadow: 'var(--shadow)',
                },
                dateNavButton: {
                    width: '44px',
                    height: '44px',
                    borderRadius: '12px',
                    border: 'none',
                    background: 'var(--accent)',
                    color: 'white',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    cursor: 'pointer',
                    transition: 'transform 0.2s, opacity 0.2s',
                },
                dateNavButtonDisabled: {
                    opacity: 0.3,
                    cursor: 'not-allowed',
                },
                dateText: {
                    fontSize: '18px',
                    fontWeight: '600',
                    color: 'var(--text-primary)',
                },
                card: {
                    background: 'var(--bg-secondary)',
                    borderRadius: '16px',
                    padding: '16px',
                    marginBottom: '12px',
                    boxShadow: 'var(--shadow)',
                    borderLeft: '4px solid var(--accent)',
                },
                cardHeader: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'flex-start',
                    marginBottom: '12px',
                },
                cardTitle: {
                    fontSize: '17px',
                    fontWeight: '600',
                    color: 'var(--text-primary)',
                    flex: 1,
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                },
                cardActions: {
                    display: 'flex',
                    gap: '8px',
                },
                actionButton: {
                    width: '32px',
                    height: '32px',
                    borderRadius: '8px',
                    border: 'none',
                    background: 'var(--bg-primary)',
                    color: 'var(--text-secondary)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    cursor: 'pointer',
                },
                cardRow: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: '8px 0',
                    borderBottom: '1px solid var(--separator)',
                },
                cardRowLast: {
                    borderBottom: 'none',
                },
                cardLabel: {
                    fontSize: '13px',
                    color: 'var(--text-tertiary)',
                    fontWeight: '500',
                },
                cardValue: {
                    fontSize: '15px',
                    color: 'var(--text-primary)',
                    textAlign: 'right',
                    maxWidth: '60%',
                    wordBreak: 'break-word',
                },
                mapLink: {
                    color: 'var(--accent)',
                    textDecoration: 'none',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '4px',
                },
                dayCost: {
                    background: 'linear-gradient(135deg, var(--accent), var(--accent-secondary))',
                    borderRadius: '16px',
                    padding: '16px',
                    marginBottom: '16px',
                    color: 'white',
                    textAlign: 'center',
                },
                dayCostLabel: {
                    fontSize: '13px',
                    opacity: 0.9,
                    marginBottom: '4px',
                },
                dayCostValue: {
                    fontSize: '24px',
                    fontWeight: '700',
                },
                budgetBar: {
                    background: 'var(--bg-secondary)',
                    borderRadius: '12px',
                    padding: '16px',
                    marginBottom: '16px',
                },
                budgetProgress: {
                    height: '8px',
                    background: 'var(--separator)',
                    borderRadius: '4px',
                    overflow: 'hidden',
                    marginTop: '8px',
                },
                budgetProgressFill: {
                    height: '100%',
                    borderRadius: '4px',
                    transition: 'width 0.3s ease',
                },
                tabBar: {
                    position: 'fixed',
                    bottom: 0,
                    left: 0,
                    right: 0,
                    background: 'var(--glass-bg)',
                    backdropFilter: 'blur(20px)',
                    WebkitBackdropFilter: 'blur(20px)',
                    borderTop: '1px solid var(--separator)',
                    display: 'flex',
                    justifyContent: 'space-around',
                    padding: '8px 0',
                    paddingBottom: 'calc(8px + env(safe-area-inset-bottom))',
                },
                tabButton: {
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    gap: '4px',
                    padding: '8px 16px',
                    border: 'none',
                    background: 'transparent',
                    color: 'var(--text-tertiary)',
                    cursor: 'pointer',
                    fontSize: '11px',
                    fontWeight: '500',
                },
                tabButtonActive: {
                    color: 'var(--accent)',
                },
                settingsItem: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: '16px',
                    background: 'var(--bg-secondary)',
                    borderRadius: '12px',
                    marginBottom: '12px',
                },
                settingsLabel: {
                    fontSize: '16px',
                    color: 'var(--text-primary)',
                },
                toggle: {
                    width: '51px',
                    height: '31px',
                    borderRadius: '16px',
                    border: 'none',
                    cursor: 'pointer',
                    position: 'relative',
                    transition: 'background 0.3s',
                },
                toggleThumb: {
                    width: '27px',
                    height: '27px',
                    borderRadius: '14px',
                    background: 'white',
                    position: 'absolute',
                    top: '2px',
                    transition: 'left 0.3s',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.2)',
                },
                button: {
                    width: '100%',
                    padding: '16px',
                    borderRadius: '12px',
                    border: 'none',
                    fontSize: '16px',
                    fontWeight: '600',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px',
                    marginBottom: '12px',
                },
                primaryButton: {
                    background: 'var(--accent)',
                    color: 'white',
                },
                secondaryButton: {
                    background: 'var(--bg-secondary)',
                    color: 'var(--accent)',
                },
                fab: {
                    position: 'fixed',
                    bottom: '120px',
                    right: '20px',
                    width: '56px',
                    height: '56px',
                    borderRadius: '28px',
                    border: 'none',
                    background: 'var(--accent)',
                    color: 'white',
                    boxShadow: '0 4px 12px rgba(0, 122, 255, 0.4)',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 50,
                },
                modal: {
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    alignItems: 'flex-end',
                    justifyContent: 'center',
                    zIndex: 1000,
                },
                modalContent: {
                    background: 'var(--bg-primary)',
                    borderRadius: '24px 24px 0 0',
                    width: '100%',
                    maxWidth: '500px',
                    maxHeight: '90vh',
                    overflow: 'auto',
                    padding: '20px',
                    paddingBottom: 'calc(20px + env(safe-area-inset-bottom))',
                },
                modalHeader: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '20px',
                },
                modalTitle: {
                    fontSize: '20px',
                    fontWeight: '600',
                    color: 'var(--text-primary)',
                },
                input: {
                    width: '100%',
                    padding: '14px 16px',
                    borderRadius: '12px',
                    border: '1px solid var(--separator)',
                    background: 'var(--bg-secondary)',
                    color: 'var(--text-primary)',
                    fontSize: '16px',
                    marginBottom: '12px',
                    outline: 'none',
                },
                inputLabel: {
                    fontSize: '13px',
                    color: 'var(--text-tertiary)',
                    marginBottom: '6px',
                    display: 'block',
                },
                totalCard: {
                    background: 'var(--bg-secondary)',
                    borderRadius: '16px',
                    padding: '20px',
                    marginBottom: '16px',
                },
                totalRow: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: '12px 0',
                    borderBottom: '1px solid var(--separator)',
                },
                emptyState: {
                    textAlign: 'center',
                    padding: '60px 20px',
                    color: 'var(--text-tertiary)',
                },
                emptyStateIcon: {
                    marginBottom: '16px',
                    opacity: 0.5,
                },
                emptyStateText: {
                    fontSize: '16px',
                    marginBottom: '8px',
                },
                emptyStateSubtext: {
                    fontSize: '14px',
                    opacity: 0.7,
                },
                chartContainer: {
                    background: 'var(--bg-secondary)',
                    borderRadius: '16px',
                    padding: '20px',
                    marginBottom: '16px',
                },
                chartBar: {
                    display: 'flex',
                    alignItems: 'center',
                    marginBottom: '12px',
                },
                chartBarLabel: {
                    width: '80px',
                    fontSize: '12px',
                    color: 'var(--text-secondary)',
                },
                chartBarTrack: {
                    flex: 1,
                    height: '24px',
                    background: 'var(--separator)',
                    borderRadius: '12px',
                    overflow: 'hidden',
                    marginRight: '8px',
                },
                chartBarFill: {
                    height: '100%',
                    borderRadius: '12px',
                    display: 'flex',
                    alignItems: 'center',
                    paddingLeft: '8px',
                    fontSize: '11px',
                    color: 'white',
                    fontWeight: '600',
                },
                colorPicker: {
                    display: 'flex',
                    gap: '8px',
                    flexWrap: 'wrap',
                    marginBottom: '16px',
                },
                colorOption: {
                    width: '40px',
                    height: '40px',
                    borderRadius: '20px',
                    border: '3px solid transparent',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: 'white',
                },
                colorOptionSelected: {
                    border: '3px solid var(--text-primary)',
                },
                searchContainer: {
                    marginBottom: '16px',
                },
                searchInput: {
                    width: '100%',
                    padding: '12px 16px',
                    paddingLeft: '44px',
                    borderRadius: '12px',
                    border: '1px solid var(--separator)',
                    background: 'var(--bg-secondary)',
                    color: 'var(--text-primary)',
                    fontSize: '16px',
                    outline: 'none',
                },
                searchIcon: {
                    position: 'absolute',
                    left: '14px',
                    top: '50%',
                    transform: 'translateY(-50%)',
                    color: 'var(--text-tertiary)',
                },
                filterContainer: {
                    display: 'flex',
                    gap: '8px',
                    overflowX: 'auto',
                    paddingBottom: '8px',
                    marginBottom: '16px',
                    scrollbarWidth: 'none',
                    msOverflowStyle: 'none',
                },
                filterChip: {
                    padding: '8px 16px',
                    borderRadius: '20px',
                    border: 'none',
                    background: 'var(--bg-secondary)',
                    color: 'var(--text-secondary)',
                    fontSize: '13px',
                    fontWeight: '500',
                    cursor: 'pointer',
                    whiteSpace: 'nowrap',
                    transition: 'all 0.2s',
                },
                filterChipActive: {
                    background: 'var(--accent)',
                    color: 'white',
                },
                dragHandle: {
                    cursor: 'grab',
                    padding: '8px',
                    color: 'var(--text-tertiary)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    touchAction: 'none',
                },
                completionToggle: {
                    width: '28px',
                    height: '28px',
                    borderRadius: '14px',
                    border: '2px solid var(--separator)',
                    background: 'transparent',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    transition: 'all 0.2s',
                    flexShrink: 0,
                },
                completionToggleActive: {
                    background: 'var(--success)',
                    borderColor: 'var(--success)',
                },
                completedCard: {
                    opacity: 0.6,
                },
                completedTitle: {
                    textDecoration: 'line-through',
                    color: 'var(--text-tertiary)',
                },
                swipeContainer: {
                    touchAction: 'pan-y',
                },
                noResults: {
                    textAlign: 'center',
                    padding: '40px 20px',
                    color: 'var(--text-tertiary)',
                },
            };

            // Trip Edit Modal
            const TripModal = ({ trip, onSave, onClose, isNew }) => {
                const [formData, setFormData] = useState(trip || {
                    'Data': '',
                    'Orario Partenza': '',
                    'Orario Arrivo': '',
                    'Mezzo': '',
                    'Costo Mezzo': '',
                    'Costo Pasto': '',
                    'Costo Hotel': '',
                    'Costo Attivit√†': '',
                    'Costi Vari': '',
                    'Luogo': '',
                    'Descrizione': '',
                    'Maps': '',
                    'Categoria': 'altro',
                    'Distanza': '',
                    'Completata': 'false'
                });

                const handleChange = (field, value) => {
                    setFormData({ ...formData, [field]: value });
                };

                return (
                    <div style={styles.modal} onClick={onClose}>
                        <div style={styles.modalContent} onClick={e => e.stopPropagation()}>
                            <div style={styles.modalHeader}>
                                <h2 style={styles.modalTitle}>{isNew ? 'Nuova Tappa' : 'Modifica Tappa'}</h2>
                                <button style={styles.actionButton} onClick={onClose}>
                                    <Icon name="x" size={20} />
                                </button>
                            </div>
                            
                            <label style={styles.inputLabel}>Data</label>
                            <input style={styles.input} value={formData['Data']} onChange={e => handleChange('Data', e.target.value)} placeholder="es. 27/11" />
                            
                            <label style={styles.inputLabel}>Orario Partenza</label>
                            <input style={styles.input} value={formData['Orario Partenza']} onChange={e => handleChange('Orario Partenza', e.target.value)} placeholder="es. 9:45" />
                            
                            <label style={styles.inputLabel}>Orario Arrivo</label>
                            <input style={styles.input} value={formData['Orario Arrivo']} onChange={e => handleChange('Orario Arrivo', e.target.value)} placeholder="es. 11:15" />
                            
                            <label style={styles.inputLabel}>Mezzo di trasporto</label>
                            <select style={{ ...styles.input, cursor: 'pointer' }} value={formData['Mezzo']} onChange={e => handleChange('Mezzo', e.target.value)}>
                                <option value="">Seleziona...</option>
                                {TRANSPORT_TYPES.map(t => (
                                    <option key={t.id} value={t.name}>{t.icon} {t.name}</option>
                                ))}
                            </select>
                            
                            <label style={styles.inputLabel}>Costo Mezzo ({currency})</label>
                            <input style={styles.input} type="number" value={formData['Costo Mezzo']} onChange={e => handleChange('Costo Mezzo', e.target.value)} placeholder="0" />
                            
                            <label style={styles.inputLabel}>Costo Pasto ({currency})</label>
                            <input style={styles.input} type="number" value={formData['Costo Pasto']} onChange={e => handleChange('Costo Pasto', e.target.value)} placeholder="0" />
                            
                            <label style={styles.inputLabel}>Costo Hotel ({currency})</label>
                            <input style={styles.input} type="number" value={formData['Costo Hotel']} onChange={e => handleChange('Costo Hotel', e.target.value)} placeholder="0" />
                            
                            <label style={styles.inputLabel}>Costo Attivit√† ({currency})</label>
                            <input style={styles.input} type="number" value={formData['Costo Attivit√†']} onChange={e => handleChange('Costo Attivit√†', e.target.value)} placeholder="0" />
                            
                            <label style={styles.inputLabel}>Luogo</label>
                            <input style={styles.input} value={formData['Luogo']} onChange={e => handleChange('Luogo', e.target.value)} placeholder="Nome del luogo" />
                            
                            <label style={styles.inputLabel}>Descrizione</label>
                            <input style={styles.input} value={formData['Descrizione']} onChange={e => handleChange('Descrizione', e.target.value)} placeholder="Descrizione attivit√†" />
                            
                            <label style={styles.inputLabel}>Categoria spesa</label>
                            <select style={{ ...styles.input, cursor: 'pointer' }} value={formData['Categoria']} onChange={e => handleChange('Categoria', e.target.value)}>
                                {EXPENSE_CATEGORIES.map(cat => (
                                    <option key={cat.id} value={cat.id}>{cat.icon} {cat.name}</option>
                                ))}
                            </select>
                            
                            <label style={styles.inputLabel}>Costi Vari ({currency})</label>
                            <input style={styles.input} type="number" value={formData['Costi Vari']} onChange={e => handleChange('Costi Vari', e.target.value)} placeholder="0" />
                            
                            <label style={styles.inputLabel}>Distanza (km)</label>
                            <input style={styles.input} type="number" value={formData['Distanza']} onChange={e => handleChange('Distanza', e.target.value)} placeholder="0" />
                            
                            <label style={styles.inputLabel}>Link Google Maps</label>
                            <input style={styles.input} value={formData['Maps']} onChange={e => handleChange('Maps', e.target.value)} placeholder="https://maps.app.goo.gl/..." />
                            
                            <button style={{ ...styles.button, ...styles.primaryButton, marginTop: '8px' }} onClick={() => onSave(formData)}>
                                <Icon name="check" size={20} />
                                Salva
                            </button>
                        </div>
                    </div>
                );
            };

            // Home Page
            const HomePage = () => {
                const currentDayTrips = groupedTrips[dates[currentDateIndex]] || [];
                const filteredDayTrips = filterTrips(currentDayTrips);
                const dayMezzoCost = currentDayTrips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costo Mezzo'), 0);
                const dayPastoCost = currentDayTrips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costo Pasto'), 0);
                const dayHotelCost = currentDayTrips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costo Hotel'), 0);
                const dayAttivitaCost = currentDayTrips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costo Attivit√†'), 0);
                const dayVariCost = currentDayTrips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costi Vari'), 0);
                const dayTotalCost = dayMezzoCost + dayPastoCost + dayHotelCost + dayAttivitaCost + dayVariCost;
                const dayDistance = currentDayTrips.reduce((acc, trip) => acc + (parseFloat(trip['Distanza']) || 0), 0);
                const completedCount = currentDayTrips.filter(t => t['Completata'] === 'true').length;

                return (
                    <>
                        <div style={styles.header}>
                            <h1 style={styles.headerTitle}>{tripTitle}</h1>
                            <p style={styles.headerSubtitle}>
                                {trips.length} {trips.length === 1 ? 'tappa' : 'tappe'} ‚Ä¢ {totalDistance.toFixed(1)} km totali
                            </p>
                            {dates.length > 0 && (
                                <div style={{ 
                                    marginTop: '12px', 
                                    padding: '12px', 
                                    background: 'var(--accent)', 
                                    borderRadius: '12px', 
                                    color: 'white',
                                    textAlign: 'center'
                                }}>
                                    <div style={{ fontSize: '12px', opacity: 0.9, marginBottom: '4px' }}>
                                        {dates[currentDateIndex]}{numPersone > 1 ? ` ‚Ä¢ ${numPersone} persone` : ''} ‚Ä¢ {completedCount}/{currentDayTrips.length} ‚úì
                                    </div>
                                    <div style={{ fontSize: '22px', fontWeight: '700' }}>
                                        {currency}{dayTotalCost.toFixed(2)}
                                    </div>
                                    <div style={{ display: 'flex', flexWrap: 'wrap', justifyContent: 'center', gap: '8px', marginTop: '6px', fontSize: '11px', opacity: 0.9 }}>
                                        {dayMezzoCost > 0 && <span>üöó{currency}{dayMezzoCost.toFixed(0)}</span>}
                                        {dayPastoCost > 0 && <span>üçΩÔ∏è{currency}{dayPastoCost.toFixed(0)}</span>}
                                        {dayHotelCost > 0 && <span>üè®{currency}{dayHotelCost.toFixed(0)}</span>}
                                        {dayAttivitaCost > 0 && <span>üéØ{currency}{dayAttivitaCost.toFixed(0)}</span>}
                                        {dayVariCost > 0 && <span>üì¶{currency}{dayVariCost.toFixed(0)}</span>}
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        <div 
                            style={{...styles.content, ...styles.swipeContainer}}
                            onTouchStart={onTouchStart}
                            onTouchMove={onTouchMove}
                            onTouchEnd={onTouchEnd}
                            ref={swipeContainerRef}
                        >
                            {dates.length > 0 && (
                                <>
                                    {/* Search Bar */}
                                    <div style={{...styles.searchContainer, position: 'relative'}}>
                                        <div style={styles.searchIcon}>
                                            <Icon name="search" size={18} />
                                        </div>
                                        <input 
                                            style={styles.searchInput}
                                            placeholder="Cerca tappe..."
                                            value={searchQuery}
                                            onChange={e => setSearchQuery(e.target.value)}
                                        />
                                    </div>

                                    {/* Category Filter */}
                                    <div style={styles.filterContainer}>
                                        <button 
                                            style={{
                                                ...styles.filterChip,
                                                ...(selectedCategory === 'all' ? styles.filterChipActive : {})
                                            }}
                                            onClick={() => setSelectedCategory('all')}
                                        >
                                            Tutte
                                        </button>
                                        {EXPENSE_CATEGORIES.map(cat => (
                                            <button 
                                                key={cat.id}
                                                style={{
                                                    ...styles.filterChip,
                                                    ...(selectedCategory === cat.id ? styles.filterChipActive : {})
                                                }}
                                                onClick={() => setSelectedCategory(cat.id)}
                                            >
                                                {cat.icon} {cat.name}
                                            </button>
                                        ))}
                                    </div>
                                </>
                            )}

                            {dates.length === 0 ? (
                                <div style={styles.emptyState}>
                                    <div style={styles.emptyStateIcon}><Icon name="map" size={48} /></div>
                                    <p style={styles.emptyStateText}>Nessun viaggio caricato</p>
                                    <p style={styles.emptyStateSubtext}>Vai nelle impostazioni per importare un file CSV</p>
                                </div>
                            ) : (
                                <>
                                    <div style={styles.dateNav}>
                                        <button style={{...styles.dateNavButton, ...(currentDateIndex === 0 ? styles.dateNavButtonDisabled : {})}} onClick={() => setCurrentDateIndex(Math.max(0, currentDateIndex - 1))} disabled={currentDateIndex === 0}>
                                            <Icon name="chevronLeft" size={20} />
                                        </button>
                                        <div style={{ textAlign: 'center' }}>
                                            <span style={styles.dateText}>{dates[currentDateIndex]}</span>
                                            <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginTop: '2px' }}>
                                                ‚Üê Scorri per cambiare ‚Üí
                                            </div>
                                        </div>
                                        <button style={{...styles.dateNavButton, ...(currentDateIndex === dates.length - 1 ? styles.dateNavButtonDisabled : {})}} onClick={() => setCurrentDateIndex(Math.min(dates.length - 1, currentDateIndex + 1))} disabled={currentDateIndex === dates.length - 1}>
                                            <Icon name="chevronRight" size={20} />
                                        </button>
                                    </div>

                                    {filteredDayTrips.length === 0 ? (
                                        <div style={styles.noResults}>
                                            <p>Nessuna tappa trovata</p>
                                            <p style={{ fontSize: '13px', marginTop: '4px' }}>Prova a modificare i filtri</p>
                                        </div>
                                    ) : (
                                    filteredDayTrips.map((trip, localIndex) => {
                                        const originalIndex = currentDayTrips.indexOf(trip);
                                        const globalIndex = getTripIndex(dates[currentDateIndex], originalIndex);
                                        const isCompleted = trip['Completata'] === 'true';
                                        const categoryColor = getCategoryColor(trip['Categoria']);
                                        
                                        return (
                                            <div 
                                                key={localIndex} 
                                                style={{ 
                                                    ...styles.card, 
                                                    borderLeftColor: categoryColor,
                                                    ...(isCompleted ? styles.completedCard : {}),
                                                    ...(draggedIndex === globalIndex ? { opacity: 0.5 } : {})
                                                }}
                                                draggable
                                                onDragStart={(e) => handleDragStart(e, globalIndex)}
                                                onDragEnd={handleDragEnd}
                                                onDragOver={handleDragOver}
                                                onDrop={(e) => handleDrop(e, globalIndex)}
                                            >
                                                <div style={styles.cardHeader}>
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flex: 1 }}>
                                                        <div style={styles.dragHandle}>
                                                            <Icon name="grip" size={16} />
                                                        </div>
                                                        <button 
                                                            style={{
                                                                ...styles.completionToggle,
                                                                ...(isCompleted ? styles.completionToggleActive : {}),
                                                                color: isCompleted ? 'white' : 'transparent'
                                                            }}
                                                            onClick={() => handleToggleComplete(globalIndex)}
                                                        >
                                                            {isCompleted && <Icon name="check" size={16} />}
                                                        </button>
                                                        <h3 style={{
                                                            ...styles.cardTitle,
                                                            ...(isCompleted ? styles.completedTitle : {})
                                                        }}>
                                                            <span style={{ fontSize: '20px' }}>{getTransportIcon(trip.Mezzo)}</span>
                                                            {trip.Luogo || 'Senza nome'}
                                                        </h3>
                                                    </div>
                                                    <div style={styles.cardActions}>
                                                        <button style={styles.actionButton} onClick={() => handleMoveTrip(globalIndex, -1)}><Icon name="arrowUp" size={16} /></button>
                                                        <button style={styles.actionButton} onClick={() => handleMoveTrip(globalIndex, 1)}><Icon name="arrowDown" size={16} /></button>
                                                        <button style={styles.actionButton} onClick={() => setEditingTrip({ data: trip, index: globalIndex })}><Icon name="edit" size={16} /></button>
                                                        <button style={{ ...styles.actionButton, color: 'var(--danger)' }} onClick={() => handleDeleteTrip(globalIndex)}><Icon name="trash" size={16} /></button>
                                                    </div>
                                                </div>
                                                
                                                <div style={styles.cardRow}>
                                                    <span style={styles.cardLabel}>Partenza</span>
                                                    <span style={styles.cardValue}>{formatTime(trip['Orario Partenza'])}</span>
                                                </div>
                                                <div style={styles.cardRow}>
                                                    <span style={styles.cardLabel}>Arrivo</span>
                                                    <span style={styles.cardValue}>{formatTime(trip['Orario Arrivo'])}</span>
                                                </div>
                                                {trip.Mezzo && (
                                                    <div style={styles.cardRow}>
                                                        <span style={styles.cardLabel}>Mezzo</span>
                                                        <span style={styles.cardValue}>{trip.Mezzo}</span>
                                                    </div>
                                                )}
                                                {trip.Descrizione && (
                                                    <div style={styles.cardRow}>
                                                        <span style={styles.cardLabel}>Descrizione</span>
                                                        <span style={styles.cardValue}>{trip.Descrizione}</span>
                                                    </div>
                                                )}
                                                {trip['Distanza'] && (
                                                    <div style={styles.cardRow}>
                                                        <span style={styles.cardLabel}>Distanza</span>
                                                        <span style={styles.cardValue}>{trip['Distanza']} km</span>
                                                    </div>
                                                )}
                                                {trip['Costo Mezzo'] && (
                                                    <div style={styles.cardRow}>
                                                        <span style={styles.cardLabel}>üöó Mezzo</span>
                                                        <span style={styles.cardValue}>{currency}{getCostWithMultiplier(trip, 'Costo Mezzo').toFixed(0)}</span>
                                                    </div>
                                                )}
                                                {trip['Costo Pasto'] && (
                                                    <div style={styles.cardRow}>
                                                        <span style={styles.cardLabel}>üçΩÔ∏è Pasto</span>
                                                        <span style={styles.cardValue}>{currency}{getCostWithMultiplier(trip, 'Costo Pasto').toFixed(0)}</span>
                                                    </div>
                                                )}
                                                {trip['Costo Hotel'] && (
                                                    <div style={styles.cardRow}>
                                                        <span style={styles.cardLabel}>üè® Hotel</span>
                                                        <span style={styles.cardValue}>{currency}{getCostWithMultiplier(trip, 'Costo Hotel').toFixed(0)}</span>
                                                    </div>
                                                )}
                                                {trip['Costo Attivit√†'] && (
                                                    <div style={styles.cardRow}>
                                                        <span style={styles.cardLabel}>üéØ Attivit√†</span>
                                                        <span style={styles.cardValue}>{currency}{getCostWithMultiplier(trip, 'Costo Attivit√†').toFixed(0)}</span>
                                                    </div>
                                                )}
                                                {trip['Costi Vari'] && (
                                                    <div style={styles.cardRow}>
                                                        <span style={styles.cardLabel}>üì¶ Vari</span>
                                                        <span style={styles.cardValue}>{currency}{getCostWithMultiplier(trip, 'Costi Vari').toFixed(0)}</span>
                                                    </div>
                                                )}
                                                {trip.Maps && (
                                                    <div style={{ ...styles.cardRow, ...styles.cardRowLast }}>
                                                        <span style={styles.cardLabel}>Posizione</span>
                                                        <div style={{ display: 'flex', gap: '8px' }}>
                                                            <a href={trip.Maps} target="_blank" rel="noopener noreferrer" style={styles.mapLink}>
                                                                <Icon name="map" size={16} />
                                                                Mappa
                                                            </a>
                                                            <a href={`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(trip.Luogo)}&travelmode=transit`} target="_blank" rel="noopener noreferrer" style={{ ...styles.mapLink, color: 'var(--success)' }}>
                                                                <Icon name="navigation" size={16} />
                                                                Naviga
                                                            </a>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })
                                    )}
                                </>
                            )}
                        </div>

                        <button style={styles.fab} onClick={() => setShowAddModal(true)}>
                            <Icon name="plus" size={24} />
                        </button>
                    </>
                );
            };

            // Costs Page
            const CostsPage = () => {
                const totalMezzo = trips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costo Mezzo'), 0);
                const totalPasto = trips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costo Pasto'), 0);
                const totalHotel = trips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costo Hotel'), 0);
                const totalAttivita = trips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costo Attivit√†'), 0);
                const totalVari = trips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costi Vari'), 0);

                // Cost breakdown for chart
                const costBreakdown = [
                    { name: 'Mezzi', icon: 'üöó', total: totalMezzo, color: '#007AFF' },
                    { name: 'Pasti', icon: 'üçΩÔ∏è', total: totalPasto, color: '#FF9500' },
                    { name: 'Hotel', icon: 'üè®', total: totalHotel, color: '#5856D6' },
                    { name: 'Attivit√†', icon: 'üéØ', total: totalAttivita, color: '#34C759' },
                    { name: 'Vari', icon: 'üì¶', total: totalVari, color: '#8E8E93' },
                ].filter(item => item.total > 0);

                const maxCost = Math.max(...costBreakdown.map(c => c.total), 1);
                const budgetPercentage = budget > 0 ? Math.min((totalCosts / budget) * 100, 100) : 0;
                const budgetRemaining = budget - totalCosts;

                // Calculate day costs with multiplier
                const getDayCostWithMultiplier = (dayTrips) => {
                    return dayTrips.reduce((acc, trip) => acc + getTripTotalCost(trip), 0);
                };

                return (
                    <>
                        <div style={styles.header}>
                            <h1 style={styles.headerTitle}>Costi</h1>
                            <p style={styles.headerSubtitle}>Riepilogo spese{numPersone > 1 ? ` per ${numPersone} persone` : ''}</p>
                        </div>
                        
                        <div style={styles.content}>
                            <div style={styles.dayCost}>
                                <p style={styles.dayCostLabel}>Totale Viaggio</p>
                                <p style={styles.dayCostValue}>{currency}{totalCosts.toFixed(2)}</p>
                            </div>

                            {budget > 0 && (
                                <div style={styles.budgetBar}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                                        <span style={{ fontSize: '14px', color: 'var(--text-secondary)' }}>Budget</span>
                                        <span style={{ fontSize: '14px', fontWeight: '600', color: budgetRemaining >= 0 ? 'var(--success)' : 'var(--danger)' }}>
                                            {budgetRemaining >= 0 ? `${currency}${budgetRemaining.toFixed(2)} rimanenti` : `${currency}${Math.abs(budgetRemaining).toFixed(2)} oltre budget`}
                                        </span>
                                    </div>
                                    <div style={styles.budgetProgress}>
                                        <div style={{...styles.budgetProgressFill, width: `${budgetPercentage}%`, background: budgetPercentage > 100 ? 'var(--danger)' : budgetPercentage > 80 ? 'var(--warning)' : 'var(--success)'}} />
                                    </div>
                                    <div style={{ fontSize: '12px', color: 'var(--text-tertiary)', marginTop: '4px', textAlign: 'right' }}>
                                        {budgetPercentage.toFixed(0)}% di {currency}{budget.toFixed(2)}
                                    </div>
                                </div>
                            )}

                            <div style={styles.totalCard}>
                                {totalMezzo > 0 && (
                                    <div style={styles.totalRow}>
                                        <span style={styles.cardLabel}>üöó Costi Mezzi</span>
                                        <span style={styles.cardValue}>{currency}{totalMezzo.toFixed(2)}</span>
                                    </div>
                                )}
                                {totalPasto > 0 && (
                                    <div style={styles.totalRow}>
                                        <span style={styles.cardLabel}>üçΩÔ∏è Costi Pasti</span>
                                        <span style={styles.cardValue}>{currency}{totalPasto.toFixed(2)}</span>
                                    </div>
                                )}
                                {totalHotel > 0 && (
                                    <div style={styles.totalRow}>
                                        <span style={styles.cardLabel}>üè® Costi Hotel</span>
                                        <span style={styles.cardValue}>{currency}{totalHotel.toFixed(2)}</span>
                                    </div>
                                )}
                                {totalAttivita > 0 && (
                                    <div style={styles.totalRow}>
                                        <span style={styles.cardLabel}>üéØ Costi Attivit√†</span>
                                        <span style={styles.cardValue}>{currency}{totalAttivita.toFixed(2)}</span>
                                    </div>
                                )}
                                {totalVari > 0 && (
                                    <div style={{ ...styles.totalRow, borderBottom: 'none' }}>
                                        <span style={styles.cardLabel}>üì¶ Costi Vari</span>
                                        <span style={styles.cardValue}>{currency}{totalVari.toFixed(2)}</span>
                                    </div>
                                )}
                            </div>

                            {costBreakdown.length > 0 && (
                                <div style={styles.chartContainer}>
                                    <h3 style={{ ...styles.cardTitle, marginBottom: '16px' }}>
                                        <Icon name="pieChart" size={20} />
                                        Per Tipo di Spesa
                                    </h3>
                                    {costBreakdown.map(item => (
                                        <div key={item.name} style={styles.chartBar}>
                                            <span style={styles.chartBarLabel}>{item.icon} {item.name}</span>
                                            <div style={styles.chartBarTrack}>
                                                <div style={{...styles.chartBarFill, width: `${(item.total / maxCost) * 100}%`, background: item.color}}>
                                                    {currency}{item.total.toFixed(0)}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            <h3 style={{ ...styles.cardTitle, marginBottom: '16px' }}>Per Giornata</h3>
                            {dates.map(date => {
                                const dayCost = getDayCostWithMultiplier(groupedTrips[date]);
                                const dayDistance = groupedTrips[date].reduce((acc, trip) => acc + (parseFloat(trip['Distanza']) || 0), 0);
                                return (
                                    <div key={date} style={styles.totalCard}>
                                        <div style={{ ...styles.totalRow, borderBottom: 'none' }}>
                                            <div>
                                                <span style={{ ...styles.cardLabel, fontSize: '15px', color: 'var(--text-primary)', display: 'block' }}>{date}</span>
                                                {dayDistance > 0 && (<span style={{ fontSize: '12px', color: 'var(--text-tertiary)' }}>{dayDistance.toFixed(1)} km</span>)}
                                            </div>
                                            <span style={{ ...styles.cardValue, fontWeight: '600' }}>{currency}{dayCost.toFixed(2)}</span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </>
                );
            };

            // Settings Page
            const SettingsPage = () => {
                const [localTitle, setLocalTitle] = useState(tripTitle);
                const [localNumPersone, setLocalNumPersone] = useState(numPersone.toString());
                
                const handleTitleBlur = () => {
                    setTripTitle(localTitle);
                };

                const handleNumPersoneBlur = () => {
                    const num = parseInt(localNumPersone) || 1;
                    setNumPersone(Math.max(1, num));
                    setLocalNumPersone(Math.max(1, num).toString());
                };

                const toggleMoltiplicatore = (field) => {
                    setMoltiplicatori(prev => ({
                        ...prev,
                        [field]: !prev[field]
                    }));
                };

                return (
                    <>
                        <div style={styles.header}>
                            <h1 style={styles.headerTitle}>Impostazioni</h1>
                            <p style={styles.headerSubtitle}>Personalizza l'app</p>
                        </div>
                        
                        <div style={styles.content}>
                            <label style={styles.inputLabel}>Nome del viaggio</label>
                            <input 
                                style={styles.input} 
                                value={localTitle} 
                                onChange={e => setLocalTitle(e.target.value)} 
                                onBlur={handleTitleBlur}
                                placeholder="Es. Viaggio in Giappone" 
                            />

                            <label style={styles.inputLabel}>Budget totale ({currency})</label>
                            <input style={styles.input} type="number" value={budget || ''} onChange={e => setBudget(parseFloat(e.target.value) || 0)} placeholder="0" />

                            <label style={styles.inputLabel}>Valuta</label>
                            <select style={{ ...styles.input, cursor: 'pointer' }} value={currency} onChange={e => setCurrency(e.target.value)}>
                                {currencies.map(curr => (<option key={curr.symbol} value={curr.symbol}>{curr.symbol} - {curr.name}</option>))}
                            </select>

                            <div style={{ ...styles.totalCard, marginTop: '8px' }}>
                                <h3 style={{ ...styles.cardTitle, marginBottom: '16px' }}>üë• Calcolo per pi√π persone</h3>
                                
                                <label style={styles.inputLabel}>Numero di persone</label>
                                <input 
                                    style={{ ...styles.input, marginBottom: '16px' }} 
                                    type="number" 
                                    min="1"
                                    value={localNumPersone} 
                                    onChange={e => setLocalNumPersone(e.target.value)}
                                    onBlur={handleNumPersoneBlur}
                                />
                                
                                <label style={styles.inputLabel}>Moltiplica per {numPersone} persone:</label>
                                
                                {[
                                    { field: 'Costo Mezzo', icon: 'üöó', label: 'Mezzi' },
                                    { field: 'Costo Pasto', icon: 'üçΩÔ∏è', label: 'Pasti' },
                                    { field: 'Costo Hotel', icon: 'üè®', label: 'Hotel' },
                                    { field: 'Costo Attivit√†', icon: 'üéØ', label: 'Attivit√†' },
                                    { field: 'Costi Vari', icon: 'üì¶', label: 'Vari' }
                                ].map(item => (
                                    <div key={item.field} style={{ ...styles.settingsItem, marginBottom: '8px', padding: '12px' }}>
                                        <span style={{ fontSize: '14px', color: 'var(--text-primary)' }}>{item.icon} {item.label}</span>
                                        <button
                                            style={{
                                                ...styles.toggle,
                                                background: moltiplicatori[item.field] ? 'var(--accent)' : 'var(--separator)',
                                                width: '44px',
                                                height: '26px'
                                            }}
                                            onClick={() => toggleMoltiplicatore(item.field)}
                                        >
                                            <div style={{
                                                ...styles.toggleThumb,
                                                width: '22px',
                                                height: '22px',
                                                left: moltiplicatori[item.field] ? '20px' : '2px'
                                            }} />
                                        </button>
                                    </div>
                                ))}
                            </div>

                            <label style={styles.inputLabel}>Colore tema</label>
                            <div style={styles.colorPicker}>
                                {ACCENT_COLORS.map(color => (
                                    <div key={color.id} style={{...styles.colorOption, background: color.color, ...(accentColor === color.id ? styles.colorOptionSelected : {})}} onClick={() => setAccentColor(color.id)}>
                                        {accentColor === color.id && <Icon name="check" size={16} />}
                                    </div>
                                ))}
                            </div>

                            <div style={styles.settingsItem}>
                                <span style={styles.settingsLabel}>Modalit√† scura</span>
                                <button style={{...styles.toggle, background: darkMode ? 'var(--accent)' : 'var(--separator)'}} onClick={() => setDarkMode(!darkMode)}>
                                    <div style={{...styles.toggleThumb, left: darkMode ? '22px' : '2px'}} />
                                </button>
                            </div>

                            <input type="file" ref={fileInputRef} accept=".csv" onChange={handleImportCSV} style={{ display: 'none' }} />
                            
                            <button style={{ ...styles.button, ...styles.primaryButton }} onClick={() => fileInputRef.current?.click()}>
                                <Icon name="upload" size={20} />
                                Importa CSV
                            </button>
                            
                            <button style={{ ...styles.button, ...styles.secondaryButton }} onClick={handleExportCSV} disabled={trips.length === 0}>
                                <Icon name="download" size={20} />
                                Esporta CSV
                            </button>

                            {trips.length > 0 && (
                                <button style={{ ...styles.button, background: 'var(--danger)', color: 'white' }} onClick={() => { if (confirm('Sei sicuro di voler eliminare tutti i dati?')) { setTrips([]); setCurrentDateIndex(0); }}}>
                                    <Icon name="trash" size={20} />
                                    Elimina tutti i dati
                                </button>
                            )}
                        </div>
                    </>
                );
            };

            return (
                <div style={styles.container}>
                    {currentPage === 'home' && <HomePage />}
                    {currentPage === 'costs' && <CostsPage />}
                    {currentPage === 'settings' && <SettingsPage />}

                    {editingTrip && (
                        <TripModal trip={editingTrip.data} onSave={(data) => handleSaveTrip(data, editingTrip.index)} onClose={() => setEditingTrip(null)} isNew={false} />
                    )}

                    {showAddModal && (
                        <TripModal trip={null} onSave={(data) => handleSaveTrip(data)} onClose={() => setShowAddModal(false)} isNew={true} />
                    )}

                    <div style={styles.tabBar}>
                        <button style={{...styles.tabButton, ...(currentPage === 'home' ? styles.tabButtonActive : {})}} onClick={() => setCurrentPage('home')}>
                            <Icon name="home" size={24} />
                            Viaggio
                        </button>
                        <button style={{...styles.tabButton, ...(currentPage === 'costs' ? styles.tabButtonActive : {})}} onClick={() => setCurrentPage('costs')}>
                            <Icon name="wallet" size={24} />
                            Costi
                        </button>
                        <button style={{...styles.tabButton, ...(currentPage === 'settings' ? styles.tabButtonActive : {})}} onClick={() => setCurrentPage('settings')}>
                            <Icon name="settings" size={24} />
                            Impostazioni
                        </button>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then((registration) => {
                    console.log('SW registered: ', registration);
                }).catch((registrationError) => {
                    console.log('SW registration failed: ', registrationError);
                });
            });
        }
    </script>
</body>
</html>
