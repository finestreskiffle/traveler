<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Travel Manager">
    <meta name="theme-color" content="#007AFF">
    <title>Travel Manager</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <!-- Leaflet CSS & JS per mappa interattiva -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-primary: #F2F2F7;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: rgba(255, 255, 255, 0.8);
            --text-primary: #000000;
            --text-secondary: #3C3C43;
            --text-tertiary: #8E8E93;
            --accent: #007AFF;
            --accent-secondary: #5856D6;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --separator: rgba(60, 60, 67, 0.1);
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        [data-theme="dark"] {
            --bg-primary: #000000;
            --bg-secondary: #1C1C1E;
            --bg-tertiary: rgba(28, 28, 30, 0.8);
            --text-primary: #FFFFFF;
            --text-secondary: #EBEBF5;
            --text-tertiary: #8E8E93;
            --separator: rgba(84, 84, 88, 0.6);
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            --glass-bg: rgba(28, 28, 30, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        /* Theme colors */
        [data-accent="blue"] { --accent: #007AFF; --accent-secondary: #5856D6; }
        [data-accent="purple"] { --accent: #AF52DE; --accent-secondary: #5856D6; }
        [data-accent="pink"] { --accent: #FF2D55; --accent-secondary: #FF375F; }
        [data-accent="red"] { --accent: #FF3B30; --accent-secondary: #FF6961; }
        [data-accent="orange"] { --accent: #FF9500; --accent-secondary: #FFCC00; }
        [data-accent="green"] { --accent: #34C759; --accent-secondary: #30D158; }
        [data-accent="teal"] { --accent: #5AC8FA; --accent-secondary: #64D2FF; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            transition: background 0.3s ease, color 0.3s ease;
        }

        #root {
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        /* Smooth Animations */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes checkBounce {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }

        @keyframes swipeDelete {
            to {
                opacity: 0;
                transform: translateX(-100%);
            }
        }

        @keyframes swipeComplete {
            to {
                opacity: 0.6;
                transform: translateX(20px);
            }
        }

        .animate-in {
            animation: slideInRight 0.3s ease-out;
        }

        .animate-fade {
            animation: fadeIn 0.3s ease-out;
        }

        .animate-scale {
            animation: scaleIn 0.2s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Constants
        const EXPENSE_CATEGORIES = [
            { id: 'trasporti', name: 'Trasporti', color: '#007AFF', icon: 'üöó' },
            { id: 'alloggio', name: 'Alloggio', color: '#5856D6', icon: 'üè®' },
            { id: 'cibo', name: 'Cibo', color: '#FF9500', icon: 'üçΩÔ∏è' },
            { id: 'attivita', name: 'Attivit√†', color: '#34C759', icon: 'üéØ' },
            { id: 'shopping', name: 'Shopping', color: '#FF2D55', icon: 'üõçÔ∏è' },
            { id: 'altro', name: 'Altro', color: '#8E8E93', icon: 'üì¶' },
        ];

        const TRANSPORT_TYPES = [
            { id: 'piedi', name: 'A piedi', icon: 'üö∂' },
            { id: 'auto', name: 'Auto', icon: 'üöó' },
            { id: 'treno', name: 'Treno', icon: 'üöÜ' },
            { id: 'aereo', name: 'Aereo', icon: '‚úàÔ∏è' },
            { id: 'bus', name: 'Bus', icon: 'üöå' },
            { id: 'metro', name: 'Metro', icon: 'üöá' },
            { id: 'taxi', name: 'Taxi', icon: 'üöï' },
            { id: 'bici', name: 'Bici', icon: 'üö¥' },
            { id: 'nave', name: 'Nave', icon: '‚õ¥Ô∏è' },
            { id: 'altro', name: 'Altro', icon: 'üöÄ' },
        ];

        const ACCENT_COLORS = [
            { id: 'blue', name: 'Blu', color: '#007AFF' },
            { id: 'purple', name: 'Viola', color: '#AF52DE' },
            { id: 'pink', name: 'Rosa', color: '#FF2D55' },
            { id: 'red', name: 'Rosso', color: '#FF3B30' },
            { id: 'orange', name: 'Arancione', color: '#FF9500' },
            { id: 'green', name: 'Verde', color: '#34C759' },
            { id: 'teal', name: 'Azzurro', color: '#5AC8FA' },
        ];

        // App Version
        const APP_VERSION = "3.0.0";

        // Translations
        const TRANSLATIONS = {
            it: {
                // Common
                save: 'Salva',
                cancel: 'Annulla',
                delete: 'Elimina',
                edit: 'Modifica',
                search: 'Cerca',
                all: 'Tutte',
                // Home
                myTrip: 'Il Mio Viaggio',
                stages: 'tappe',
                stage: 'tappa',
                totalKm: 'km totali',
                people: 'persone',
                completed: 'completate',
                day: 'Giorno',
                of: 'di',
                searchStages: 'Cerca tappe...',
                noTripLoaded: 'Nessun viaggio caricato',
                noTripSubtext: 'Vai nelle impostazioni per importare un file CSV',
                noResults: 'Nessuna tappa trovata',
                noResultsSubtext: 'Prova a modificare i filtri',
                newStage: 'Nuova Tappa',
                editStage: 'Modifica Tappa',
                // Fields
                date: 'Data',
                departureTime: 'Orario Partenza',
                arrivalTime: 'Orario Arrivo',
                transport: 'Mezzo di trasporto',
                transportCost: 'Costo Mezzo',
                mealCost: 'Costo Pasto',
                hotelCost: 'Costo Hotel',
                activityCost: 'Costo Attivit√†',
                place: 'Luogo',
                description: 'Descrizione',
                expenseCategory: 'Categoria spesa',
                miscCosts: 'Costi Vari',
                distance: 'Distanza (km)',
                mapsLink: 'Link Google Maps',
                notes: 'Note',
                weatherLocation: 'Meteo Luogo',
                weatherLocationPlaceholder: 'Es. Tokyo, Osaka, Kyoto',
                position: 'Posizione',
                map: 'Mappa',
                navigate: 'Naviga',
                // Costs
                costs: 'Costi',
                expensesSummary: 'Riepilogo spese',
                tripTotal: 'Totale Viaggio',
                budget: 'Budget',
                remaining: 'rimanenti',
                overBudget: 'oltre budget',
                transportsCost: 'Costi Mezzi',
                mealsCost: 'Costi Pasti',
                hotelsCost: 'Costi Hotel',
                activitiesCost: 'Costi Attivit√†',
                miscCost: 'Costi Vari',
                byExpenseType: 'Per Tipo di Spesa',
                byDay: 'Per Giornata',
                statistics: 'Statistiche',
                avgPerDay: 'Media Giornaliera',
                mostExpensiveDay: 'Giorno pi√π costoso',
                cheapestDay: 'Giorno pi√π economico',
                kmPerTransport: 'Km per mezzo',
                // Settings
                settings: 'Impostazioni',
                customizeApp: 'Personalizza l\'app',
                tripName: 'Nome del viaggio',
                totalBudget: 'Budget totale',
                currency: 'Valuta',
                multiPersonCalc: 'Calcolo per pi√π persone',
                numPeople: 'Numero di persone',
                multiplyFor: 'Moltiplica per',
                transports: 'Mezzi',
                meals: 'Pasti',
                hotels: 'Hotel',
                activities: 'Attivit√†',
                misc: 'Vari',
                themeColor: 'Colore tema',
                darkMode: 'Modalit√† scura',
                language: 'Lingua',
                importCSV: 'Importa CSV',
                exportCSV: 'Esporta CSV',
                deleteAllData: 'Elimina tutti i dati',
                deleteConfirm: 'Sei sicuro di voler eliminare tutti i dati?',
                // Tabs
                trip: 'Viaggio',
                weather: 'Meteo',
                // Weather
                loading: 'Caricamento...',
                noWeatherData: 'Nessun dato meteo disponibile',
                addLocationForWeather: 'Aggiungi luoghi alle tappe per vedere il meteo',
                // Map
                mapTab: 'Mappa',
                mapTitle: 'Mappa Viaggio',
                noMapData: 'Nessun dato da visualizzare',
                addStagesForMap: 'Aggiungi tappe con coordinate per vedere la mappa',
                allDays: 'Tutti i giorni',
                // Timeline
                timelineView: 'Timeline',
                cardView: 'Card',
                // Version
                version: 'Versione',
                madeWith: 'Fatto con ‚ù§Ô∏è per i viaggiatori'
            },
            en: {
                // Common
                save: 'Save',
                cancel: 'Cancel',
                delete: 'Delete',
                edit: 'Edit',
                search: 'Search',
                all: 'All',
                // Home
                myTrip: 'My Trip',
                stages: 'stops',
                stage: 'stop',
                totalKm: 'total km',
                people: 'people',
                completed: 'completed',
                day: 'Day',
                of: 'of',
                searchStages: 'Search stops...',
                noTripLoaded: 'No trip loaded',
                noTripSubtext: 'Go to settings to import a CSV file',
                noResults: 'No stops found',
                noResultsSubtext: 'Try changing the filters',
                newStage: 'New Stop',
                editStage: 'Edit Stop',
                // Fields
                date: 'Date',
                departureTime: 'Departure Time',
                arrivalTime: 'Arrival Time',
                transport: 'Transport',
                transportCost: 'Transport Cost',
                mealCost: 'Meal Cost',
                hotelCost: 'Hotel Cost',
                activityCost: 'Activity Cost',
                place: 'Place',
                description: 'Description',
                expenseCategory: 'Expense Category',
                miscCosts: 'Misc Costs',
                distance: 'Distance (km)',
                mapsLink: 'Google Maps Link',
                notes: 'Notes',
                weatherLocation: 'Weather Location',
                weatherLocationPlaceholder: 'E.g. Tokyo, Osaka, Kyoto',
                position: 'Position',
                map: 'Map',
                navigate: 'Navigate',
                // Costs
                costs: 'Costs',
                expensesSummary: 'Expenses Summary',
                tripTotal: 'Trip Total',
                budget: 'Budget',
                remaining: 'remaining',
                overBudget: 'over budget',
                transportsCost: 'Transport Costs',
                mealsCost: 'Meal Costs',
                hotelsCost: 'Hotel Costs',
                activitiesCost: 'Activity Costs',
                miscCost: 'Misc Costs',
                byExpenseType: 'By Expense Type',
                byDay: 'By Day',
                statistics: 'Statistics',
                avgPerDay: 'Daily Average',
                mostExpensiveDay: 'Most Expensive Day',
                cheapestDay: 'Cheapest Day',
                kmPerTransport: 'Km by transport',
                // Settings
                settings: 'Settings',
                customizeApp: 'Customize app',
                tripName: 'Trip name',
                totalBudget: 'Total budget',
                currency: 'Currency',
                multiPersonCalc: 'Multi-person calculation',
                numPeople: 'Number of people',
                multiplyFor: 'Multiply for',
                transports: 'Transports',
                meals: 'Meals',
                hotels: 'Hotels',
                activities: 'Activities',
                misc: 'Misc',
                themeColor: 'Theme color',
                darkMode: 'Dark mode',
                language: 'Language',
                importCSV: 'Import CSV',
                exportCSV: 'Export CSV',
                deleteAllData: 'Delete all data',
                deleteConfirm: 'Are you sure you want to delete all data?',
                // Tabs
                trip: 'Trip',
                weather: 'Weather',
                // Weather
                loading: 'Loading...',
                noWeatherData: 'No weather data available',
                addLocationForWeather: 'Add locations to stops to see weather',
                // Map
                mapTab: 'Map',
                mapTitle: 'Trip Map',
                noMapData: 'No data to display',
                addStagesForMap: 'Add stops with coordinates to see the map',
                allDays: 'All days',
                // Timeline
                timelineView: 'Timeline',
                cardView: 'Card',
                // Version
                version: 'Version',
                madeWith: 'Made with ‚ù§Ô∏è for travelers'
            }
        };

        // Utility functions
        const parseCSV = (csvText) => {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(';').map(h => h.trim());
            const trips = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(';');
                const trip = {};
                headers.forEach((header, index) => {
                    trip[header] = values[index]?.trim() || '';
                });
                if (!trip['Categoria']) trip['Categoria'] = 'altro';
                trips.push(trip);
            }
            return trips;
        };

        const generateCSV = (trips) => {
            if (trips.length === 0) return '';
            const headers = ['Data', 'Orario Partenza', 'Orario Arrivo', 'Mezzo', 'Costo Mezzo', 'Costo Pasto', 'Costo Hotel', 'Costo Attivit√†', 'Costi Vari', 'Luogo', 'Descrizione', 'Maps', 'Categoria', 'Distanza', 'Completata', 'Note', 'Meteo Luogo'];
            const lines = [headers.join(';')];
            
            trips.forEach(trip => {
                const values = headers.map(h => trip[h] || '');
                lines.push(values.join(';'));
            });
            
            return lines.join('\n');
        };

        const groupByDate = (trips) => {
            const groups = {};
            trips.forEach(trip => {
                const date = trip.Data || 'Senza data';
                if (!groups[date]) groups[date] = [];
                groups[date].push(trip);
            });
            return groups;
        };

        const formatTime = (time) => {
            if (!time || time === '-' || time === '') return 'N/D';
            return time;
        };

        const getTransportIcon = (mezzo) => {
            if (!mezzo) return 'üìç';
            const transport = TRANSPORT_TYPES.find(t => 
                mezzo.toLowerCase().includes(t.id) || 
                mezzo.toLowerCase().includes(t.name.toLowerCase())
            );
            return transport ? transport.icon : 'üìç';
        };

        const getCategoryColor = (categoryId) => {
            const cat = EXPENSE_CATEGORIES.find(c => c.id === categoryId);
            return cat ? cat.color : '#8E8E93';
        };

        // Components
        const Icon = ({ name, size = 24 }) => {
            const icons = {
                chevronLeft: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 18l-6-6 6-6"/></svg>,
                chevronRight: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18l6-6-6-6"/></svg>,
                settings: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
                home: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
                wallet: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>,
                plus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
                trash: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
                edit: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
                map: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>,
                upload: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
                download: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
                arrowUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>,
                arrowDown: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>,
                check: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
                x: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
                navigation: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>,
                pieChart: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
                search: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
                grip: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>,
                mapPin: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
                list: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
                clock: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
                globe: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
            };
            return icons[name] || null;
        };

        const App = () => {
            const [trips, setTrips] = useState([]);
            const [currentPage, setCurrentPage] = useState('home');
            const [currentDateIndex, setCurrentDateIndex] = useState(0);
            const [darkMode, setDarkMode] = useState(false);
            const [editingTrip, setEditingTrip] = useState(null);
            const [showAddModal, setShowAddModal] = useState(false);
            const [tripTitle, setTripTitle] = useState('Il Mio Viaggio');
            const [currency, setCurrency] = useState('‚Ç¨');
            const [budget, setBudget] = useState(0);
            const [accentColor, setAccentColor] = useState('blue');
            const [numPersone, setNumPersone] = useState(1);
            const [moltiplicatori, setMoltiplicatori] = useState({
                'Costo Mezzo': false,
                'Costo Pasto': false,
                'Costo Hotel': false,
                'Costo Attivit√†': false,
                'Costi Vari': false
            });
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('all');
            const [language, setLanguage] = useState('it');
            const [weatherData, setWeatherData] = useState({});
            const [swipingCard, setSwipingCard] = useState(null);
            const [viewMode, setViewMode] = useState('cards'); // 'cards' o 'timeline'
            const fileInputRef = useRef(null);

            const currencies = [
                { symbol: '‚Ç¨', name: 'Euro (EUR)' },
                { symbol: '$', name: 'Dollaro USA (USD)' },
                { symbol: '¬£', name: 'Sterlina (GBP)' },
                { symbol: '¬•', name: 'Yen (JPY)' },
                { symbol: '‚Ç£', name: 'Franco Svizzero (CHF)' },
                { symbol: 'C$', name: 'Dollaro Canadese (CAD)' },
                { symbol: 'A$', name: 'Dollaro Australiano (AUD)' },
                { symbol: '‚Çπ', name: 'Rupia Indiana (INR)' },
                { symbol: 'ÂÖÉ', name: 'Yuan Cinese (CNY)' },
                { symbol: '‚Ç©', name: 'Won Coreano (KRW)' },
                { symbol: 'R$', name: 'Real Brasiliano (BRL)' },
                { symbol: '‚ÇΩ', name: 'Rublo Russo (RUB)' },
                { symbol: 'kr', name: 'Corona Svedese (SEK)' },
                { symbol: 'z≈Ç', name: 'Zloty Polacco (PLN)' },
                { symbol: '‡∏ø', name: 'Baht Thailandese (THB)' },
            ];

            // Load from localStorage
            useEffect(() => {
                const savedTrips = localStorage.getItem('travelManagerTrips');
                const savedDarkMode = localStorage.getItem('travelManagerDarkMode');
                const savedTripTitle = localStorage.getItem('travelManagerTripTitle');
                const savedCurrency = localStorage.getItem('travelManagerCurrency');
                const savedBudget = localStorage.getItem('travelManagerBudget');
                const savedAccentColor = localStorage.getItem('travelManagerAccentColor');
                const savedNumPersone = localStorage.getItem('travelManagerNumPersone');
                const savedMoltiplicatori = localStorage.getItem('travelManagerMoltiplicatori');
                const savedLanguage = localStorage.getItem('travelManagerLanguage');
                
                if (savedTrips) setTrips(JSON.parse(savedTrips));
                if (savedDarkMode) setDarkMode(JSON.parse(savedDarkMode));
                if (savedTripTitle) setTripTitle(savedTripTitle);
                if (savedCurrency) setCurrency(savedCurrency);
                if (savedBudget) setBudget(parseFloat(savedBudget));
                if (savedAccentColor) setAccentColor(savedAccentColor);
                if (savedNumPersone) setNumPersone(parseInt(savedNumPersone));
                if (savedMoltiplicatori) setMoltiplicatori(JSON.parse(savedMoltiplicatori));
                if (savedLanguage) setLanguage(savedLanguage);
            }, []);

            // Save to localStorage
            useEffect(() => {
                localStorage.setItem('travelManagerTrips', JSON.stringify(trips));
            }, [trips]);

            useEffect(() => {
                localStorage.setItem('travelManagerDarkMode', JSON.stringify(darkMode));
                document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light');
                document.documentElement.setAttribute('lang', language);
            }, [darkMode, language]);

            useEffect(() => {
                localStorage.setItem('travelManagerTripTitle', tripTitle);
            }, [tripTitle]);

            useEffect(() => {
                localStorage.setItem('travelManagerCurrency', currency);
            }, [currency]);

            useEffect(() => {
                localStorage.setItem('travelManagerBudget', budget.toString());
            }, [budget]);

            useEffect(() => {
                localStorage.setItem('travelManagerAccentColor', accentColor);
                document.documentElement.setAttribute('data-accent', accentColor);
            }, [accentColor]);

            useEffect(() => {
                localStorage.setItem('travelManagerNumPersone', numPersone.toString());
            }, [numPersone]);

            useEffect(() => {
                localStorage.setItem('travelManagerMoltiplicatori', JSON.stringify(moltiplicatori));
            }, [moltiplicatori]);

            useEffect(() => {
                localStorage.setItem('travelManagerLanguage', language);
            }, [language]);

            // Translation helper
            const t = (key) => TRANSLATIONS[language][key] || key;

            // Weather loading state
            const [weatherLoading, setWeatherLoading] = useState(false);
            
            // Coordinates cache (persists across renders)
            const coordsCacheRef = useRef({});

            // Extract coordinates from Google Maps link
            const extractCoordinatesFromMapsLink = (mapsLink) => {
                if (!mapsLink) return null;
                
                // Format: https://www.google.com/maps/@lat,lng,zoom
                const coordsMatch1 = mapsLink.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
                if (coordsMatch1) {
                    return { latitude: parseFloat(coordsMatch1[1]), longitude: parseFloat(coordsMatch1[2]) };
                }
                
                // Format: https://www.google.com/maps/place/.../@lat,lng
                const coordsMatch2 = mapsLink.match(/\/place\/[^@]*@(-?\d+\.\d+),(-?\d+\.\d+)/);
                if (coordsMatch2) {
                    return { latitude: parseFloat(coordsMatch2[1]), longitude: parseFloat(coordsMatch2[2]) };
                }
                
                // Format: ?q=lat,lng
                const coordsMatch3 = mapsLink.match(/[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/);
                if (coordsMatch3) {
                    return { latitude: parseFloat(coordsMatch3[1]), longitude: parseFloat(coordsMatch3[2]) };
                }
                
                return null;
            };

            // Fetch with timeout helper
            const fetchWithTimeout = async (url, timeout = 5000) => {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                try {
                    const response = await fetch(url, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    return response;
                } catch (error) {
                    clearTimeout(timeoutId);
                    throw error;
                }
            };

            // Get coordinates for a location (with caching)
            const getCoordinatesForLocation = async (locationName) => {
                if (!locationName) return null;
                
                const cacheKey = locationName.toLowerCase().trim();
                
                // Check cache first
                if (coordsCacheRef.current[cacheKey]) {
                    return coordsCacheRef.current[cacheKey];
                }
                
                try {
                    const geoResponse = await fetchWithTimeout(
                        `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(locationName)}&count=1&language=${language}`,
                        5000
                    );
                    const geoData = await geoResponse.json();
                    
                    if (geoData.results && geoData.results.length > 0) {
                        const result = geoData.results[0];
                        const coords = {
                            latitude: result.latitude,
                            longitude: result.longitude,
                            name: result.name,
                            country: result.country
                        };
                        
                        // Cache the result
                        coordsCacheRef.current[cacheKey] = coords;
                        console.log(`üìç Geocoded: ${locationName} ‚Üí ${result.name}, ${result.country}`);
                        return coords;
                    }
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.warn(`Geocoding failed for: ${locationName}`, error);
                    }
                }
                
                // Cache null result to avoid retrying
                coordsCacheRef.current[cacheKey] = null;
                return null;
            };

            // Parse date from trip format (DD/MM or DD/MM/YYYY)
            const parseTripDate = (dateStr) => {
                if (!dateStr) return null;
                const dateParts = dateStr.split('/');
                if (dateParts.length >= 2) {
                    const day = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1;
                    const year = dateParts.length === 3 ? parseInt(dateParts[2]) : new Date().getFullYear();
                    return new Date(year, month, day);
                }
                return null;
            };

            // Fetch weather data for all trips (OPTIMIZED)
            useEffect(() => {
                const fetchAllWeather = async () => {
                    if (trips.length === 0) return;
                    
                    setWeatherLoading(true);
                    const weatherResults = {};
                    
                    // Step 1: Group trips by unique location+date combinations
                    const uniqueCombinations = new Map(); // key: "location|date" -> { coords, date, tripIndices }
                    
                    for (let i = 0; i < trips.length; i++) {
                        const trip = trips[i];
                        const weatherLocation = (trip['Meteo Luogo'] || '').trim();
                        
                        // Skip if no weather location specified
                        if (!weatherLocation) continue;
                        
                        const tripDate = parseTripDate(trip.Data);
                        if (!tripDate) continue;
                        
                        const dateStr = tripDate.toISOString().split('T')[0];
                        const key = `${weatherLocation.toLowerCase()}|${dateStr}`;
                        
                        if (!uniqueCombinations.has(key)) {
                            uniqueCombinations.set(key, {
                                location: weatherLocation,
                                date: tripDate,
                                dateStr: dateStr,
                                tripIndices: [],
                                mapsLink: trip.Maps // Keep maps link for coordinate extraction
                            });
                        }
                        uniqueCombinations.get(key).tripIndices.push(i);
                        
                        // Update maps link if this trip has one with coordinates
                        if (trip.Maps && extractCoordinatesFromMapsLink(trip.Maps)) {
                            uniqueCombinations.get(key).mapsLink = trip.Maps;
                        }
                    }
                    
                    console.log(`üå§Ô∏è Weather: ${uniqueCombinations.size} unique location/date combinations for ${trips.length} trips`);
                    
                    // Step 2: Get coordinates for each unique location (parallel, max 5 at a time)
                    const combinations = Array.from(uniqueCombinations.values());
                    const BATCH_SIZE = 5;
                    
                    for (let i = 0; i < combinations.length; i += BATCH_SIZE) {
                        const batch = combinations.slice(i, i + BATCH_SIZE);
                        
                        await Promise.all(batch.map(async (combo) => {
                            // Try to get coords from Maps link first
                            let coords = combo.mapsLink ? extractCoordinatesFromMapsLink(combo.mapsLink) : null;
                            
                            // Fall back to geocoding
                            if (!coords) {
                                coords = await getCoordinatesForLocation(combo.location);
                            }
                            
                            combo.coords = coords;
                        }));
                    }
                    
                    // Step 3: Group by coordinates to minimize weather API calls
                    const coordsToWeather = new Map(); // key: "lat,lng" -> weather data array
                    
                    for (const combo of combinations) {
                        if (!combo.coords) continue;
                        
                        const coordKey = `${combo.coords.latitude.toFixed(2)},${combo.coords.longitude.toFixed(2)}`;
                        
                        if (!coordsToWeather.has(coordKey)) {
                            coordsToWeather.set(coordKey, {
                                coords: combo.coords,
                                combinations: []
                            });
                        }
                        coordsToWeather.get(coordKey).combinations.push(combo);
                    }
                    
                    console.log(`üå§Ô∏è Weather: ${coordsToWeather.size} unique coordinates to fetch`);
                    
                    // Step 4: Fetch weather for each unique coordinate (parallel, max 5 at a time)
                    const coordGroups = Array.from(coordsToWeather.values());
                    
                    for (let i = 0; i < coordGroups.length; i += BATCH_SIZE) {
                        const batch = coordGroups.slice(i, i + BATCH_SIZE);
                        
                        await Promise.all(batch.map(async (group) => {
                            try {
                                const weatherResponse = await fetchWithTimeout(
                                    `https://api.open-meteo.com/v1/forecast?latitude=${group.coords.latitude}&longitude=${group.coords.longitude}&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto&forecast_days=16`,
                                    8000
                                );
                                const data = await weatherResponse.json();
                                
                                if (!data.daily) return;
                                
                                // Assign weather to each combination using these coords
                                for (const combo of group.combinations) {
                                    const dateIndex = data.daily.time.findIndex(d => d === combo.dateStr);
                                    
                                    if (dateIndex !== -1) {
                                        const weatherInfo = {
                                            date: combo.dateStr,
                                            tempMax: data.daily.temperature_2m_max[dateIndex],
                                            tempMin: data.daily.temperature_2m_min[dateIndex],
                                            weathercode: data.daily.weathercode[dateIndex],
                                            locationName: group.coords.name || combo.location
                                        };
                                        
                                        // Assign to all trips with this combination
                                        for (const tripIndex of combo.tripIndices) {
                                            weatherResults[tripIndex] = weatherInfo;
                                        }
                                    }
                                }
                            } catch (error) {
                                if (error.name !== 'AbortError') {
                                    console.warn(`Weather fetch failed for coords ${group.coords.latitude},${group.coords.longitude}`, error);
                                }
                            }
                        }));
                    }
                    
                    console.log(`‚úÖ Weather loaded for ${Object.keys(weatherResults).length} trips`);
                    setWeatherData(weatherResults);
                    setWeatherLoading(false);
                };

                fetchAllWeather();
            }, [trips, language]);

            const groupedTrips = groupByDate(trips);
            const dates = Object.keys(groupedTrips);

            // Helper to get cost with multiplier
            const getCostWithMultiplier = (trip, costField) => {
                const baseCost = parseFloat(trip[costField]) || 0;
                if (moltiplicatori[costField] && numPersone > 1) {
                    return baseCost * numPersone;
                }
                return baseCost;
            };

            // Helper to get total cost for a trip
            const getTripTotalCost = (trip) => {
                return getCostWithMultiplier(trip, 'Costo Mezzo') +
                       getCostWithMultiplier(trip, 'Costo Pasto') +
                       getCostWithMultiplier(trip, 'Costo Hotel') +
                       getCostWithMultiplier(trip, 'Costo Attivit√†') +
                       getCostWithMultiplier(trip, 'Costi Vari');
            };

            const totalCosts = trips.reduce((acc, trip) => {
                return acc + getTripTotalCost(trip);
            }, 0);

            const totalDistance = trips.reduce((acc, trip) => {
                return acc + (parseFloat(trip['Distanza']) || 0);
            }, 0);

            const handleImportCSV = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const parsedTrips = parseCSV(e.target.result);
                        setTrips(parsedTrips);
                        setCurrentDateIndex(0);
                    };
                    reader.readAsText(file);
                }
            };

            const handleExportCSV = () => {
                const csv = generateCSV(trips);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'viaggio.csv';
                link.click();
                URL.revokeObjectURL(url);
            };

            const handleDeleteTrip = (tripIndex) => {
                const newTrips = trips.filter((_, index) => index !== tripIndex);
                setTrips(newTrips);
            };

            const handleSaveTrip = (tripData, originalIndex = null) => {
                if (originalIndex !== null) {
                    const newTrips = [...trips];
                    newTrips[originalIndex] = tripData;
                    setTrips(newTrips);
                } else {
                    setTrips([...trips, tripData]);
                }
                setEditingTrip(null);
                setShowAddModal(false);
            };

            const handleMoveTrip = (tripIndex, direction) => {
                const newTrips = [...trips];
                const newIndex = tripIndex + direction;
                if (newIndex >= 0 && newIndex < newTrips.length) {
                    [newTrips[tripIndex], newTrips[newIndex]] = [newTrips[newIndex], newTrips[tripIndex]];
                    setTrips(newTrips);
                }
            };

            const handleToggleComplete = (tripIndex) => {
                const newTrips = [...trips];
                newTrips[tripIndex] = {
                    ...newTrips[tripIndex],
                    'Completata': newTrips[tripIndex]['Completata'] === 'true' ? 'false' : 'true'
                };
                setTrips(newTrips);
            };

            // Swipe handlers - using refs for better performance
            const touchStartX = useRef(null);
            const touchStartY = useRef(null);
            const isSwiping = useRef(false);

            const handleSwipeStart = (e) => {
                // Don't interfere with interactive elements
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.tagName === 'SELECT') {
                    return;
                }
                touchStartX.current = e.touches[0].clientX;
                touchStartY.current = e.touches[0].clientY;
                isSwiping.current = false;
            };

            const handleSwipeMove = (e) => {
                if (touchStartX.current === null) return;
                
                const deltaX = Math.abs(e.touches[0].clientX - touchStartX.current);
                const deltaY = Math.abs(e.touches[0].clientY - touchStartY.current);
                
                // Only swipe if horizontal movement is greater than vertical
                if (deltaX > deltaY && deltaX > 10) {
                    isSwiping.current = true;
                }
            };

            const handleSwipeEnd = (e) => {
                if (touchStartX.current === null || !isSwiping.current) {
                    touchStartX.current = null;
                    touchStartY.current = null;
                    return;
                }

                const touchEndX = e.changedTouches[0].clientX;
                const distance = touchStartX.current - touchEndX;
                const minSwipeDistance = 50;

                if (distance > minSwipeDistance && currentDateIndex < dates.length - 1) {
                    setCurrentDateIndex(prev => Math.min(dates.length - 1, prev + 1));
                } else if (distance < -minSwipeDistance && currentDateIndex > 0) {
                    setCurrentDateIndex(prev => Math.max(0, prev - 1));
                }

                touchStartX.current = null;
                touchStartY.current = null;
                isSwiping.current = false;
            };

            // Filter trips based on search and category
            const filterTrips = (tripsToFilter) => {
                return tripsToFilter.filter(trip => {
                    const matchesSearch = searchQuery === '' || 
                        (trip.Luogo && trip.Luogo.toLowerCase().includes(searchQuery.toLowerCase())) ||
                        (trip.Descrizione && trip.Descrizione.toLowerCase().includes(searchQuery.toLowerCase()));
                    
                    const matchesCategory = selectedCategory === 'all' || trip.Categoria === selectedCategory;
                    
                    return matchesSearch && matchesCategory;
                });
            };

            const getTripIndex = (date, localIndex) => {
                let globalIndex = 0;
                for (const d of dates) {
                    if (d === date) {
                        return globalIndex + localIndex;
                    }
                    globalIndex += groupedTrips[d].length;
                }
                return -1;
            };

            const styles = {
                container: {
                    maxWidth: '500px',
                    margin: '0 auto',
                    minHeight: '100vh',
                    display: 'flex',
                    flexDirection: 'column',
                    background: 'var(--bg-primary)',
                },
                header: {
                    position: 'sticky',
                    top: 0,
                    zIndex: 100,
                    background: 'var(--glass-bg)',
                    backdropFilter: 'blur(20px)',
                    WebkitBackdropFilter: 'blur(20px)',
                    borderBottom: '1px solid var(--separator)',
                    padding: '16px 20px',
                },
                headerTitle: {
                    fontSize: '28px',
                    fontWeight: '700',
                    color: 'var(--text-primary)',
                    marginBottom: '4px',
                },
                headerSubtitle: {
                    fontSize: '14px',
                    color: 'var(--text-tertiary)',
                },
                content: {
                    flex: 1,
                    padding: '16px 20px',
                    paddingBottom: '180px',
                },
                dateNav: {
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    marginBottom: '16px',
                    padding: '12px 16px',
                    background: 'var(--bg-secondary)',
                    borderRadius: '16px',
                    boxShadow: 'var(--shadow)',
                },
                dateNavButton: {
                    width: '44px',
                    height: '44px',
                    borderRadius: '12px',
                    border: 'none',
                    background: 'var(--accent)',
                    color: 'white',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    cursor: 'pointer',
                    transition: 'transform 0.2s, opacity 0.2s',
                },
                dateNavButtonDisabled: {
                    opacity: 0.3,
                    cursor: 'not-allowed',
                },
                dateText: {
                    fontSize: '18px',
                    fontWeight: '600',
                    color: 'var(--text-primary)',
                },
                card: {
                    background: 'var(--bg-secondary)',
                    borderRadius: '16px',
                    padding: '16px',
                    marginBottom: '12px',
                    boxShadow: 'var(--shadow)',
                    borderLeft: '4px solid var(--accent)',
                },
                cardHeader: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'flex-start',
                    marginBottom: '12px',
                },
                cardTitle: {
                    fontSize: '17px',
                    fontWeight: '600',
                    color: 'var(--text-primary)',
                    flex: 1,
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                },
                cardActions: {
                    display: 'flex',
                    gap: '8px',
                },
                actionButton: {
                    width: '32px',
                    height: '32px',
                    borderRadius: '8px',
                    border: 'none',
                    background: 'var(--bg-primary)',
                    color: 'var(--text-secondary)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    cursor: 'pointer',
                },
                cardRow: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: '8px 0',
                    borderBottom: '1px solid var(--separator)',
                },
                cardRowLast: {
                    borderBottom: 'none',
                },
                cardLabel: {
                    fontSize: '13px',
                    color: 'var(--text-tertiary)',
                    fontWeight: '500',
                },
                cardValue: {
                    fontSize: '15px',
                    color: 'var(--text-primary)',
                    textAlign: 'right',
                    maxWidth: '60%',
                    wordBreak: 'break-word',
                },
                mapLink: {
                    color: 'var(--accent)',
                    textDecoration: 'none',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '4px',
                },
                dayCost: {
                    background: 'linear-gradient(135deg, var(--accent), var(--accent-secondary))',
                    borderRadius: '16px',
                    padding: '16px',
                    marginBottom: '16px',
                    color: 'white',
                    textAlign: 'center',
                },
                dayCostLabel: {
                    fontSize: '13px',
                    opacity: 0.9,
                    marginBottom: '4px',
                },
                dayCostValue: {
                    fontSize: '24px',
                    fontWeight: '700',
                },
                budgetBar: {
                    background: 'var(--bg-secondary)',
                    borderRadius: '12px',
                    padding: '16px',
                    marginBottom: '16px',
                },
                budgetProgress: {
                    height: '8px',
                    background: 'var(--separator)',
                    borderRadius: '4px',
                    overflow: 'hidden',
                    marginTop: '8px',
                },
                budgetProgressFill: {
                    height: '100%',
                    borderRadius: '4px',
                    transition: 'width 0.3s ease',
                },
                tabBar: {
                    position: 'fixed',
                    bottom: 0,
                    left: 0,
                    right: 0,
                    background: 'var(--glass-bg)',
                    backdropFilter: 'blur(20px)',
                    WebkitBackdropFilter: 'blur(20px)',
                    borderTop: '1px solid var(--separator)',
                    display: 'flex',
                    justifyContent: 'space-around',
                    padding: '8px 0',
                    paddingBottom: 'calc(8px + env(safe-area-inset-bottom))',
                },
                tabButton: {
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    gap: '4px',
                    padding: '8px 16px',
                    border: 'none',
                    background: 'transparent',
                    color: 'var(--text-tertiary)',
                    cursor: 'pointer',
                    fontSize: '11px',
                    fontWeight: '500',
                },
                tabButtonActive: {
                    color: 'var(--accent)',
                },
                settingsItem: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: '16px',
                    background: 'var(--bg-secondary)',
                    borderRadius: '12px',
                    marginBottom: '12px',
                },
                settingsLabel: {
                    fontSize: '16px',
                    color: 'var(--text-primary)',
                },
                toggle: {
                    width: '51px',
                    height: '31px',
                    borderRadius: '16px',
                    border: 'none',
                    cursor: 'pointer',
                    position: 'relative',
                    transition: 'background 0.3s',
                },
                toggleThumb: {
                    width: '27px',
                    height: '27px',
                    borderRadius: '14px',
                    background: 'white',
                    position: 'absolute',
                    top: '2px',
                    transition: 'left 0.3s',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.2)',
                },
                button: {
                    width: '100%',
                    padding: '16px',
                    borderRadius: '12px',
                    border: 'none',
                    fontSize: '16px',
                    fontWeight: '600',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px',
                    marginBottom: '12px',
                },
                primaryButton: {
                    background: 'var(--accent)',
                    color: 'white',
                },
                secondaryButton: {
                    background: 'var(--bg-secondary)',
                    color: 'var(--accent)',
                },
                fab: {
                    position: 'fixed',
                    bottom: '120px',
                    right: '20px',
                    width: '56px',
                    height: '56px',
                    borderRadius: '28px',
                    border: 'none',
                    background: 'var(--accent)',
                    color: 'white',
                    boxShadow: '0 4px 12px rgba(0, 122, 255, 0.4)',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 50,
                },
                modal: {
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    alignItems: 'flex-end',
                    justifyContent: 'center',
                    zIndex: 1000,
                },
                modalContent: {
                    background: 'var(--bg-primary)',
                    borderRadius: '24px 24px 0 0',
                    width: '100%',
                    maxWidth: '500px',
                    maxHeight: '90vh',
                    overflow: 'auto',
                    padding: '20px',
                    paddingBottom: 'calc(20px + env(safe-area-inset-bottom))',
                },
                modalHeader: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    marginBottom: '20px',
                },
                modalTitle: {
                    fontSize: '20px',
                    fontWeight: '600',
                    color: 'var(--text-primary)',
                },
                input: {
                    width: '100%',
                    padding: '14px 16px',
                    borderRadius: '12px',
                    border: '1px solid var(--separator)',
                    background: 'var(--bg-secondary)',
                    color: 'var(--text-primary)',
                    fontSize: '16px',
                    marginBottom: '12px',
                    outline: 'none',
                },
                inputLabel: {
                    fontSize: '13px',
                    color: 'var(--text-tertiary)',
                    marginBottom: '6px',
                    display: 'block',
                },
                totalCard: {
                    background: 'var(--bg-secondary)',
                    borderRadius: '16px',
                    padding: '20px',
                    marginBottom: '16px',
                },
                totalRow: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: '12px 0',
                    borderBottom: '1px solid var(--separator)',
                },
                emptyState: {
                    textAlign: 'center',
                    padding: '60px 20px',
                    color: 'var(--text-tertiary)',
                },
                emptyStateIcon: {
                    marginBottom: '16px',
                    opacity: 0.5,
                },
                emptyStateText: {
                    fontSize: '16px',
                    marginBottom: '8px',
                },
                emptyStateSubtext: {
                    fontSize: '14px',
                    opacity: 0.7,
                },
                chartContainer: {
                    background: 'var(--bg-secondary)',
                    borderRadius: '16px',
                    padding: '20px',
                    marginBottom: '16px',
                },
                chartBar: {
                    display: 'flex',
                    alignItems: 'center',
                    marginBottom: '12px',
                },
                chartBarLabel: {
                    width: '80px',
                    fontSize: '12px',
                    color: 'var(--text-secondary)',
                },
                chartBarTrack: {
                    flex: 1,
                    height: '24px',
                    background: 'var(--separator)',
                    borderRadius: '12px',
                    overflow: 'hidden',
                    marginRight: '8px',
                },
                chartBarFill: {
                    height: '100%',
                    borderRadius: '12px',
                    display: 'flex',
                    alignItems: 'center',
                    paddingLeft: '8px',
                    fontSize: '11px',
                    color: 'white',
                    fontWeight: '600',
                },
                colorPicker: {
                    display: 'flex',
                    gap: '8px',
                    flexWrap: 'wrap',
                    marginBottom: '16px',
                },
                colorOption: {
                    width: '40px',
                    height: '40px',
                    borderRadius: '20px',
                    border: '3px solid transparent',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: 'white',
                },
                colorOptionSelected: {
                    border: '3px solid var(--text-primary)',
                },
                searchContainer: {
                    marginBottom: '16px',
                },
                searchInput: {
                    width: '100%',
                    padding: '12px 16px',
                    paddingLeft: '44px',
                    borderRadius: '12px',
                    border: '1px solid var(--separator)',
                    background: 'var(--bg-secondary)',
                    color: 'var(--text-primary)',
                    fontSize: '16px',
                    outline: 'none',
                },
                searchIcon: {
                    position: 'absolute',
                    left: '14px',
                    top: '50%',
                    transform: 'translateY(-50%)',
                    color: 'var(--text-tertiary)',
                },
                filterContainer: {
                    display: 'flex',
                    gap: '8px',
                    overflowX: 'auto',
                    paddingBottom: '8px',
                    marginBottom: '16px',
                    scrollbarWidth: 'none',
                    msOverflowStyle: 'none',
                },
                filterChip: {
                    padding: '8px 16px',
                    borderRadius: '20px',
                    border: 'none',
                    background: 'var(--bg-secondary)',
                    color: 'var(--text-secondary)',
                    fontSize: '13px',
                    fontWeight: '500',
                    cursor: 'pointer',
                    whiteSpace: 'nowrap',
                    transition: 'all 0.2s',
                },
                filterChipActive: {
                    background: 'var(--accent)',
                    color: 'white',
                },
                completionToggle: {
                    width: '28px',
                    height: '28px',
                    borderRadius: '14px',
                    border: '2px solid var(--separator)',
                    background: 'transparent',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    transition: 'all 0.2s',
                    flexShrink: 0,
                },
                completionToggleActive: {
                    background: 'var(--success)',
                    borderColor: 'var(--success)',
                },
                completedCard: {
                    opacity: 0.6,
                },
                completedTitle: {
                    textDecoration: 'line-through',
                    color: 'var(--text-tertiary)',
                },
                swipeZone: {
                    minHeight: '200px',
                },
                noResults: {
                    textAlign: 'center',
                    padding: '40px 20px',
                    color: 'var(--text-tertiary)',
                },
            };

            // Trip Edit Modal
            const TripModal = ({ trip, onSave, onClose, isNew }) => {
                const [formData, setFormData] = useState(trip || {
                    'Data': '',
                    'Orario Partenza': '',
                    'Orario Arrivo': '',
                    'Mezzo': '',
                    'Costo Mezzo': '',
                    'Costo Pasto': '',
                    'Costo Hotel': '',
                    'Costo Attivit√†': '',
                    'Costi Vari': '',
                    'Luogo': '',
                    'Descrizione': '',
                    'Maps': '',
                    'Categoria': 'altro',
                    'Distanza': '',
                    'Completata': 'false',
                    'Note': '',
                    'Meteo Luogo': ''
                });

                const handleChange = (field, value) => {
                    setFormData({ ...formData, [field]: value });
                };

                return (
                    <div style={styles.modal} onClick={onClose}>
                        <div style={styles.modalContent} onClick={e => e.stopPropagation()}>
                            <div style={styles.modalHeader}>
                                <h2 style={styles.modalTitle}>{isNew ? t('newStage') : t('editStage')}</h2>
                                <button style={styles.actionButton} onClick={onClose}>
                                    <Icon name="x" size={20} />
                                </button>
                            </div>
                            
                            <label style={styles.inputLabel}>{t('date')}</label>
                            <input style={styles.input} value={formData['Data']} onChange={e => handleChange('Data', e.target.value)} placeholder="es. 27/11" />
                            
                            <label style={styles.inputLabel}>{t('departureTime')}</label>
                            <input style={styles.input} value={formData['Orario Partenza']} onChange={e => handleChange('Orario Partenza', e.target.value)} placeholder="es. 9:45" />
                            
                            <label style={styles.inputLabel}>{t('arrivalTime')}</label>
                            <input style={styles.input} value={formData['Orario Arrivo']} onChange={e => handleChange('Orario Arrivo', e.target.value)} placeholder="es. 11:15" />
                            
                            <label style={styles.inputLabel}>{t('transport')}</label>
                            <select style={{ ...styles.input, cursor: 'pointer' }} value={formData['Mezzo']} onChange={e => handleChange('Mezzo', e.target.value)}>
                                <option value="">{t('search')}...</option>
                                {TRANSPORT_TYPES.map(t => (
                                    <option key={t.id} value={t.name}>{t.icon} {t.name}</option>
                                ))}
                            </select>
                            
                            <label style={styles.inputLabel}>{t('transportCost')} ({currency})</label>
                            <input style={styles.input} type="number" value={formData['Costo Mezzo']} onChange={e => handleChange('Costo Mezzo', e.target.value)} placeholder="0" />
                            
                            <label style={styles.inputLabel}>{t('mealCost')} ({currency})</label>
                            <input style={styles.input} type="number" value={formData['Costo Pasto']} onChange={e => handleChange('Costo Pasto', e.target.value)} placeholder="0" />
                            
                            <label style={styles.inputLabel}>{t('hotelCost')} ({currency})</label>
                            <input style={styles.input} type="number" value={formData['Costo Hotel']} onChange={e => handleChange('Costo Hotel', e.target.value)} placeholder="0" />
                            
                            <label style={styles.inputLabel}>{t('activityCost')} ({currency})</label>
                            <input style={styles.input} type="number" value={formData['Costo Attivit√†']} onChange={e => handleChange('Costo Attivit√†', e.target.value)} placeholder="0" />
                            
                            <label style={styles.inputLabel}>{t('place')}</label>
                            <input style={styles.input} value={formData['Luogo']} onChange={e => handleChange('Luogo', e.target.value)} placeholder={t('place')} />
                            
                            <label style={styles.inputLabel}>{t('description')}</label>
                            <input style={styles.input} value={formData['Descrizione']} onChange={e => handleChange('Descrizione', e.target.value)} placeholder={t('description')} />
                            
                            <label style={styles.inputLabel}>{t('expenseCategory')}</label>
                            <select style={{ ...styles.input, cursor: 'pointer' }} value={formData['Categoria']} onChange={e => handleChange('Categoria', e.target.value)}>
                                {EXPENSE_CATEGORIES.map(cat => (
                                    <option key={cat.id} value={cat.id}>{cat.icon} {cat.name}</option>
                                ))}
                            </select>
                            
                            <label style={styles.inputLabel}>{t('miscCosts')} ({currency})</label>
                            <input style={styles.input} type="number" value={formData['Costi Vari']} onChange={e => handleChange('Costi Vari', e.target.value)} placeholder="0" />
                            
                            <label style={styles.inputLabel}>{t('distance')}</label>
                            <input style={styles.input} type="number" value={formData['Distanza']} onChange={e => handleChange('Distanza', e.target.value)} placeholder="0" />
                            
                            <label style={styles.inputLabel}>{t('mapsLink')}</label>
                            <input style={styles.input} value={formData['Maps']} onChange={e => handleChange('Maps', e.target.value)} placeholder="https://maps.app.goo.gl/..." />
                            
                            <label style={styles.inputLabel}>{t('notes')}</label>
                            <textarea 
                                style={{...styles.input, minHeight: '80px', fontFamily: 'inherit', resize: 'vertical'}} 
                                value={formData['Note']} 
                                onChange={e => handleChange('Note', e.target.value)} 
                                placeholder={t('notes')}
                            />
                            
                            <label style={styles.inputLabel}>{t('weatherLocation')}</label>
                            <input 
                                style={styles.input} 
                                value={formData['Meteo Luogo']} 
                                onChange={e => handleChange('Meteo Luogo', e.target.value)} 
                                placeholder={t('weatherLocationPlaceholder')}
                            />
                            <div style={{ fontSize: '12px', color: 'var(--text-tertiary)', marginTop: '4px', marginBottom: '12px' }}>
                                üí° {language === 'it' ? 'Citt√† per il meteo (es. Tokyo, Osaka). Se vuoto, usa campo Luogo.' : 'City for weather (e.g. Tokyo, Osaka). If empty, uses Place field.'}
                            </div>
                            
                            <button type="button" style={{ ...styles.button, ...styles.primaryButton, marginTop: '8px' }} onClick={() => onSave(formData)}>
                                <Icon name="check" size={20} />
                                {t('save')}
                            </button>
                        </div>
                    </div>
                );
            };

            // Home Page
            const HomePage = () => {
                const currentDayTrips = groupedTrips[dates[currentDateIndex]] || [];
                const filteredDayTrips = filterTrips(currentDayTrips);
                const dayMezzoCost = currentDayTrips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costo Mezzo'), 0);
                const dayPastoCost = currentDayTrips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costo Pasto'), 0);
                const dayHotelCost = currentDayTrips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costo Hotel'), 0);
                const dayAttivitaCost = currentDayTrips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costo Attivit√†'), 0);
                const dayVariCost = currentDayTrips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costi Vari'), 0);
                const dayTotalCost = dayMezzoCost + dayPastoCost + dayHotelCost + dayAttivitaCost + dayVariCost;
                const dayDistance = currentDayTrips.reduce((acc, trip) => acc + (parseFloat(trip['Distanza']) || 0), 0);
                const completedCount = currentDayTrips.filter(t => t['Completata'] === 'true').length;

                return (
                    <>
                        <div style={styles.header}>
                            <h1 style={styles.headerTitle}>{tripTitle}</h1>
                            <p style={styles.headerSubtitle}>
                                {trips.length} {trips.length === 1 ? t('stage') : t('stages')} ‚Ä¢ {totalDistance.toFixed(1)} {t('totalKm')}
                            </p>
                            {dates.length > 0 && (
                                <div style={{ 
                                    marginTop: '12px', 
                                    padding: '12px', 
                                    background: 'var(--accent)', 
                                    borderRadius: '12px', 
                                    color: 'white',
                                    textAlign: 'center'
                                }}>
                                    <div style={{ fontSize: '12px', opacity: 0.9, marginBottom: '4px' }}>
                                        {dates[currentDateIndex]}{numPersone > 1 ? ` ‚Ä¢ ${numPersone} ${t('people')}` : ''} ‚Ä¢ {completedCount}/{currentDayTrips.length} ‚úì
                                    </div>
                                    <div style={{ fontSize: '22px', fontWeight: '700' }}>
                                        {currency}{dayTotalCost.toFixed(2)}
                                    </div>
                                    <div style={{ display: 'flex', flexWrap: 'wrap', justifyContent: 'center', gap: '8px', marginTop: '6px', fontSize: '11px', opacity: 0.9 }}>
                                        {dayMezzoCost > 0 && <span>üöó{currency}{dayMezzoCost.toFixed(0)}</span>}
                                        {dayPastoCost > 0 && <span>üçΩÔ∏è{currency}{dayPastoCost.toFixed(0)}</span>}
                                        {dayHotelCost > 0 && <span>üè®{currency}{dayHotelCost.toFixed(0)}</span>}
                                        {dayAttivitaCost > 0 && <span>üéØ{currency}{dayAttivitaCost.toFixed(0)}</span>}
                                        {dayVariCost > 0 && <span>üì¶{currency}{dayVariCost.toFixed(0)}</span>}
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        <div style={styles.content}>
                            {dates.length > 0 && (
                                <>
                                    {/* Search Bar */}
                                    <div style={{...styles.searchContainer, position: 'relative'}}>
                                        <div style={styles.searchIcon}>
                                            <Icon name="search" size={18} />
                                        </div>
                                        <input 
                                            type="text"
                                            style={styles.searchInput}
                                            placeholder={t('searchStages')}
                                            value={searchQuery}
                                            onChange={e => setSearchQuery(e.target.value)}
                                        />
                                    </div>

                                    {/* Category Filter */}
                                    <div style={styles.filterContainer}>
                                        <button 
                                            type="button"
                                            style={{
                                                ...styles.filterChip,
                                                ...(selectedCategory === 'all' ? styles.filterChipActive : {})
                                            }}
                                            onClick={() => setSelectedCategory('all')}
                                        >
                                            {t('all')}
                                        </button>
                                        {EXPENSE_CATEGORIES.map(cat => (
                                            <button 
                                                type="button"
                                                key={cat.id}
                                                style={{
                                                    ...styles.filterChip,
                                                    ...(selectedCategory === cat.id ? styles.filterChipActive : {})
                                                }}
                                                onClick={() => setSelectedCategory(cat.id)}
                                            >
                                                {cat.icon} {cat.name}
                                            </button>
                                        ))}
                                    </div>

                                    {/* View Mode Toggle */}
                                    <div style={{ 
                                        display: 'flex', 
                                        background: 'var(--bg-secondary)', 
                                        borderRadius: '10px', 
                                        padding: '4px',
                                        marginBottom: '16px'
                                    }}>
                                        <button
                                            type="button"
                                            style={{
                                                flex: 1,
                                                padding: '8px 16px',
                                                border: 'none',
                                                borderRadius: '8px',
                                                background: viewMode === 'cards' ? 'var(--accent)' : 'transparent',
                                                color: viewMode === 'cards' ? 'white' : 'var(--text-secondary)',
                                                fontSize: '13px',
                                                fontWeight: '600',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: '6px'
                                            }}
                                            onClick={() => setViewMode('cards')}
                                        >
                                            <Icon name="list" size={16} />
                                            {t('cardView')}
                                        </button>
                                        <button
                                            type="button"
                                            style={{
                                                flex: 1,
                                                padding: '8px 16px',
                                                border: 'none',
                                                borderRadius: '8px',
                                                background: viewMode === 'timeline' ? 'var(--accent)' : 'transparent',
                                                color: viewMode === 'timeline' ? 'white' : 'var(--text-secondary)',
                                                fontSize: '13px',
                                                fontWeight: '600',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: '6px'
                                            }}
                                            onClick={() => setViewMode('timeline')}
                                        >
                                            <Icon name="clock" size={16} />
                                            {t('timelineView')}
                                        </button>
                                    </div>
                                </>
                            )}

                            {dates.length === 0 ? (
                                <div style={styles.emptyState}>
                                    <div style={styles.emptyStateIcon}><Icon name="map" size={48} /></div>
                                    <p style={styles.emptyStateText}>{t('noTripLoaded')}</p>
                                    <p style={styles.emptyStateSubtext}>{t('noTripSubtext')}</p>
                                </div>
                            ) : (
                                <>
                                    <div style={styles.dateNav}>
                                        <button type="button" style={{...styles.dateNavButton, ...(currentDateIndex === 0 ? styles.dateNavButtonDisabled : {})}} onClick={() => setCurrentDateIndex(Math.max(0, currentDateIndex - 1))} disabled={currentDateIndex === 0}>
                                            <Icon name="chevronLeft" size={20} />
                                        </button>
                                        <div style={{ textAlign: 'center' }}>
                                            <span style={styles.dateText}>{dates[currentDateIndex]}</span>
                                            <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginTop: '2px' }}>
                                                {t('day')} {currentDateIndex + 1} {t('of')} {dates.length}
                                                {weatherLoading && <span style={{ marginLeft: '8px' }}>üå§Ô∏è ...</span>}
                                            </div>
                                        </div>
                                        <button type="button" style={{...styles.dateNavButton, ...(currentDateIndex === dates.length - 1 ? styles.dateNavButtonDisabled : {})}} onClick={() => setCurrentDateIndex(Math.min(dates.length - 1, currentDateIndex + 1))} disabled={currentDateIndex === dates.length - 1}>
                                            <Icon name="chevronRight" size={20} />
                                        </button>
                                    </div>

                                    {/* Swipe zone for cards/timeline */}
                                    <div 
                                        style={styles.swipeZone}
                                        onTouchStart={handleSwipeStart}
                                        onTouchMove={handleSwipeMove}
                                        onTouchEnd={handleSwipeEnd}
                                    >
                                    {filteredDayTrips.length === 0 ? (
                                        <div style={styles.noResults}>
                                            <p>{t('noResults')}</p>
                                            <p style={{ fontSize: '13px', marginTop: '4px' }}>{t('noResultsSubtext')}</p>
                                        </div>
                                    ) : viewMode === 'timeline' ? (
                                        /* Timeline View */
                                        <div style={{ position: 'relative', paddingLeft: '24px' }}>
                                            {/* Timeline line */}
                                            <div style={{
                                                position: 'absolute',
                                                left: '8px',
                                                top: '8px',
                                                bottom: '8px',
                                                width: '2px',
                                                background: 'var(--separator)',
                                                borderRadius: '1px'
                                            }} />
                                            
                                            {filteredDayTrips.map((trip, localIndex) => {
                                                const originalIndex = currentDayTrips.indexOf(trip);
                                                const globalIndex = getTripIndex(dates[currentDateIndex], originalIndex);
                                                const isCompleted = trip['Completata'] === 'true';
                                                const categoryColor = getCategoryColor(trip['Categoria']);
                                                const tripCost = getTripTotalCost(trip);
                                                
                                                return (
                                                    <div key={localIndex} style={{ 
                                                        position: 'relative',
                                                        paddingBottom: '20px',
                                                        opacity: isCompleted ? 0.6 : 1
                                                    }}>
                                                        {/* Timeline dot */}
                                                        <div style={{
                                                            position: 'absolute',
                                                            left: '-20px',
                                                            top: '4px',
                                                            width: '16px',
                                                            height: '16px',
                                                            borderRadius: '50%',
                                                            background: isCompleted ? 'var(--success)' : categoryColor,
                                                            border: '3px solid var(--bg-primary)',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'center',
                                                            cursor: 'pointer',
                                                            zIndex: 1
                                                        }}
                                                        onClick={() => handleToggleComplete(globalIndex)}
                                                        >
                                                            {isCompleted && <Icon name="check" size={8} />}
                                                        </div>
                                                        
                                                        {/* Time label */}
                                                        <div style={{
                                                            position: 'absolute',
                                                            left: '-60px',
                                                            top: '2px',
                                                            fontSize: '11px',
                                                            fontWeight: '600',
                                                            color: 'var(--text-tertiary)',
                                                            width: '35px',
                                                            textAlign: 'right'
                                                        }}>
                                                            {formatTime(trip['Orario Partenza'])}
                                                        </div>
                                                        
                                                        {/* Content */}
                                                        <div 
                                                            style={{
                                                                background: 'var(--bg-secondary)',
                                                                borderRadius: '12px',
                                                                padding: '12px',
                                                                marginLeft: '8px',
                                                                borderLeft: `3px solid ${categoryColor}`,
                                                                cursor: 'pointer'
                                                            }}
                                                            onClick={() => setEditingTrip({ data: trip, index: globalIndex })}
                                                        >
                                                            <div style={{ display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between', gap: '8px' }}>
                                                                <div style={{ flex: 1 }}>
                                                                    <div style={{ 
                                                                        fontSize: '15px', 
                                                                        fontWeight: '600',
                                                                        color: 'var(--text-primary)',
                                                                        textDecoration: isCompleted ? 'line-through' : 'none',
                                                                        display: 'flex',
                                                                        alignItems: 'center',
                                                                        gap: '6px'
                                                                    }}>
                                                                        <span style={{ fontSize: '16px' }}>{getTransportIcon(trip.Mezzo)}</span>
                                                                        {trip.Luogo || 'Senza nome'}
                                                                    </div>
                                                                    {trip.Descrizione && (
                                                                        <div style={{ 
                                                                            fontSize: '13px', 
                                                                            color: 'var(--text-secondary)',
                                                                            marginTop: '4px'
                                                                        }}>
                                                                            {trip.Descrizione}
                                                                        </div>
                                                                    )}
                                                                    <div style={{ 
                                                                        display: 'flex', 
                                                                        gap: '12px', 
                                                                        marginTop: '8px',
                                                                        fontSize: '12px',
                                                                        color: 'var(--text-tertiary)'
                                                                    }}>
                                                                        {trip['Orario Arrivo'] && trip['Orario Arrivo'] !== '-' && (
                                                                            <span>‚Üí {formatTime(trip['Orario Arrivo'])}</span>
                                                                        )}
                                                                        {trip.Mezzo && (
                                                                            <span>{trip.Mezzo}</span>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <div style={{ textAlign: 'right' }}>
                                                                    {tripCost > 0 && (
                                                                        <div style={{ 
                                                                            fontSize: '14px', 
                                                                            fontWeight: '700',
                                                                            color: 'var(--accent)'
                                                                        }}>
                                                                            {currency}{tripCost.toFixed(0)}
                                                                        </div>
                                                                    )}
                                                                    {weatherData[globalIndex] && (
                                                                        <div style={{ 
                                                                            fontSize: '13px',
                                                                            marginTop: '4px'
                                                                        }}>
                                                                            {(() => {
                                                                                const code = weatherData[globalIndex].weathercode;
                                                                                return code === 0 ? '‚òÄÔ∏è' : 
                                                                                       code <= 3 ? '‚õÖ' : 
                                                                                       code <= 48 ? 'üå´Ô∏è' : 
                                                                                       code <= 67 ? 'üåßÔ∏è' : 
                                                                                       code <= 77 ? '‚ùÑÔ∏è' : '‚õàÔ∏è';
                                                                            })()}
                                                                            {Math.round(weatherData[globalIndex].tempMax)}¬∞
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Quick actions */}
                                                            {trip.Maps && (
                                                                <div style={{ 
                                                                    display: 'flex', 
                                                                    gap: '16px', 
                                                                    marginTop: '8px',
                                                                    paddingTop: '8px',
                                                                    borderTop: '1px solid var(--separator)'
                                                                }}>
                                                                    <a 
                                                                        href={trip.Maps} 
                                                                        target="_blank" 
                                                                        rel="noopener noreferrer" 
                                                                        style={styles.mapLink}
                                                                        onClick={e => e.stopPropagation()}
                                                                    >
                                                                        <Icon name="map" size={14} />
                                                                        {t('map')}
                                                                    </a>
                                                                    <a 
                                                                        href={`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(trip.Luogo)}&travelmode=transit`} 
                                                                        target="_blank" 
                                                                        rel="noopener noreferrer" 
                                                                        style={{ ...styles.mapLink, color: 'var(--success)' }}
                                                                        onClick={e => e.stopPropagation()}
                                                                    >
                                                                        <Icon name="navigation" size={14} />
                                                                        {t('navigate')}
                                                                    </a>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ) : (
                                        /* Card View */
                                    filteredDayTrips.map((trip, localIndex) => {
                                        const originalIndex = currentDayTrips.indexOf(trip);
                                        const globalIndex = getTripIndex(dates[currentDateIndex], originalIndex);
                                        const isCompleted = trip['Completata'] === 'true';
                                        const categoryColor = getCategoryColor(trip['Categoria']);
                                        
                                        return (
                                            <div 
                                                key={localIndex} 
                                                style={{ 
                                                    ...styles.card, 
                                                    borderLeftColor: categoryColor,
                                                    ...(isCompleted ? styles.completedCard : {})
                                                }}
                                            >
                                                <div style={styles.cardHeader}>
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flex: 1 }}>
                                                        <button 
                                                            type="button"
                                                            style={{
                                                                ...styles.completionToggle,
                                                                ...(isCompleted ? styles.completionToggleActive : {}),
                                                                color: isCompleted ? 'white' : 'transparent'
                                                            }}
                                                            onClick={() => handleToggleComplete(globalIndex)}
                                                        >
                                                            {isCompleted && <Icon name="check" size={16} />}
                                                        </button>
                                                        <h3 style={{
                                                            ...styles.cardTitle,
                                                            ...(isCompleted ? styles.completedTitle : {})
                                                        }}>
                                                            <span style={{ fontSize: '20px' }}>{getTransportIcon(trip.Mezzo)}</span>
                                                            {trip.Luogo || 'Senza nome'}
                                                        </h3>
                                                    </div>
                                                    <div style={styles.cardActions}>
                                                        <button type="button" style={styles.actionButton} onClick={() => handleMoveTrip(globalIndex, -1)}><Icon name="arrowUp" size={16} /></button>
                                                        <button type="button" style={styles.actionButton} onClick={() => handleMoveTrip(globalIndex, 1)}><Icon name="arrowDown" size={16} /></button>
                                                        <button type="button" style={styles.actionButton} onClick={() => setEditingTrip({ data: trip, index: globalIndex })}><Icon name="edit" size={16} /></button>
                                                        <button type="button" style={{ ...styles.actionButton, color: 'var(--danger)' }} onClick={() => handleDeleteTrip(globalIndex)}><Icon name="trash" size={16} /></button>
                                                    </div>
                                                </div>

                                                {/* Weather for this specific trip */}
                                                {weatherData[globalIndex] && (
                                                    <div style={{ 
                                                        padding: '8px 12px',
                                                        background: 'var(--bg-tertiary)',
                                                        borderRadius: '8px',
                                                        marginBottom: '12px',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '12px'
                                                    }}>
                                                        <div style={{ fontSize: '32px' }}>
                                                            {(() => {
                                                                const code = weatherData[globalIndex].weathercode;
                                                                return code === 0 ? '‚òÄÔ∏è' : 
                                                                       code <= 3 ? '‚õÖ' : 
                                                                       code <= 48 ? 'üå´Ô∏è' : 
                                                                       code <= 67 ? 'üåßÔ∏è' : 
                                                                       code <= 77 ? '‚ùÑÔ∏è' : '‚õàÔ∏è';
                                                            })()}
                                                        </div>
                                                        <div style={{ flex: 1 }}>
                                                            <div style={{ fontSize: '11px', color: 'var(--text-tertiary)', marginBottom: '2px' }}>
                                                                {t('weather')}
                                                            </div>
                                                            <div style={{ fontSize: '18px', fontWeight: '600', color: 'var(--text-primary)' }}>
                                                                {Math.round(weatherData[globalIndex].tempMax)}¬∞ / {Math.round(weatherData[globalIndex].tempMin)}¬∞
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                <div style={styles.cardRow}>
                                                    <span style={styles.cardLabel}>{t('departureTime')}</span>
                                                    <span style={styles.cardValue}>{formatTime(trip['Orario Partenza'])}</span>
                                                </div>
                                                <div style={styles.cardRow}>
                                                    <span style={styles.cardLabel}>{t('arrivalTime')}</span>
                                                    <span style={styles.cardValue}>{formatTime(trip['Orario Arrivo'])}</span>
                                                </div>
                                                {trip.Mezzo && (
                                                    <div style={styles.cardRow}>
                                                        <span style={styles.cardLabel}>{t('transport')}</span>
                                                        <span style={styles.cardValue}>{trip.Mezzo}</span>
                                                    </div>
                                                )}
                                                {trip.Descrizione && (
                                                    <div style={styles.cardRow}>
                                                        <span style={styles.cardLabel}>{t('description')}</span>
                                                        <span style={styles.cardValue}>{trip.Descrizione}</span>
                                                    </div>
                                                )}
                                                {trip['Distanza'] && (
                                                    <div style={styles.cardRow}>
                                                        <span style={styles.cardLabel}>{t('distance')}</span>
                                                        <span style={styles.cardValue}>{trip['Distanza']} km</span>
                                                    </div>
                                                )}
                                                {trip['Costo Mezzo'] && (
                                                    <div style={styles.cardRow}>
                                                        <span style={styles.cardLabel}>üöó {t('transports')}</span>
                                                        <span style={styles.cardValue}>{currency}{getCostWithMultiplier(trip, 'Costo Mezzo').toFixed(0)}</span>
                                                    </div>
                                                )}
                                                {trip['Costo Pasto'] && (
                                                    <div style={styles.cardRow}>
                                                        <span style={styles.cardLabel}>üçΩÔ∏è {t('meals')}</span>
                                                        <span style={styles.cardValue}>{currency}{getCostWithMultiplier(trip, 'Costo Pasto').toFixed(0)}</span>
                                                    </div>
                                                )}
                                                {trip['Costo Hotel'] && (
                                                    <div style={styles.cardRow}>
                                                        <span style={styles.cardLabel}>üè® {t('hotels')}</span>
                                                        <span style={styles.cardValue}>{currency}{getCostWithMultiplier(trip, 'Costo Hotel').toFixed(0)}</span>
                                                    </div>
                                                )}
                                                {trip['Costo Attivit√†'] && (
                                                    <div style={styles.cardRow}>
                                                        <span style={styles.cardLabel}>üéØ {t('activities')}</span>
                                                        <span style={styles.cardValue}>{currency}{getCostWithMultiplier(trip, 'Costo Attivit√†').toFixed(0)}</span>
                                                    </div>
                                                )}
                                                {trip['Costi Vari'] && (
                                                    <div style={styles.cardRow}>
                                                        <span style={styles.cardLabel}>üì¶ {t('misc')}</span>
                                                        <span style={styles.cardValue}>{currency}{getCostWithMultiplier(trip, 'Costi Vari').toFixed(0)}</span>
                                                    </div>
                                                )}
                                                {trip['Note'] && (
                                                    <div style={styles.cardRow}>
                                                        <span style={styles.cardLabel}>üìù {t('notes')}</span>
                                                        <span style={{...styles.cardValue, whiteSpace: 'pre-wrap', textAlign: 'left'}}>{trip['Note']}</span>
                                                    </div>
                                                )}
                                                {trip.Maps && (
                                                    <div style={{ ...styles.cardRow, ...styles.cardRowLast }}>
                                                        <span style={styles.cardLabel}>{t('position')}</span>
                                                        <div style={{ display: 'flex', gap: '8px' }}>
                                                            <a href={trip.Maps} target="_blank" rel="noopener noreferrer" style={styles.mapLink}>
                                                                <Icon name="map" size={16} />
                                                                {t('map')}
                                                            </a>
                                                            <a href={`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(trip.Luogo)}&travelmode=transit`} target="_blank" rel="noopener noreferrer" style={{ ...styles.mapLink, color: 'var(--success)' }}>
                                                                <Icon name="navigation" size={16} />
                                                                {t('navigate')}
                                                            </a>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })
                                    )}
                                    </div>
                                </>
                            )}
                        </div>

                        <button type="button" style={styles.fab} onClick={() => setShowAddModal(true)}>
                            <Icon name="plus" size={24} />
                        </button>
                    </>
                );
            };

            // Costs Page
            const CostsPage = () => {
                const totalMezzo = trips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costo Mezzo'), 0);
                const totalPasto = trips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costo Pasto'), 0);
                const totalHotel = trips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costo Hotel'), 0);
                const totalAttivita = trips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costo Attivit√†'), 0);
                const totalVari = trips.reduce((acc, trip) => acc + getCostWithMultiplier(trip, 'Costi Vari'), 0);

                // Cost breakdown for chart
                const costBreakdown = [
                    { name: 'Mezzi', icon: 'üöó', total: totalMezzo, color: '#007AFF' },
                    { name: 'Pasti', icon: 'üçΩÔ∏è', total: totalPasto, color: '#FF9500' },
                    { name: 'Hotel', icon: 'üè®', total: totalHotel, color: '#5856D6' },
                    { name: 'Attivit√†', icon: 'üéØ', total: totalAttivita, color: '#34C759' },
                    { name: 'Vari', icon: 'üì¶', total: totalVari, color: '#8E8E93' },
                ].filter(item => item.total > 0);

                const maxCost = Math.max(...costBreakdown.map(c => c.total), 1);
                const budgetPercentage = budget > 0 ? Math.min((totalCosts / budget) * 100, 100) : 0;
                const budgetRemaining = budget - totalCosts;

                // Calculate day costs with multiplier
                const getDayCostWithMultiplier = (dayTrips) => {
                    return dayTrips.reduce((acc, trip) => acc + getTripTotalCost(trip), 0);
                };

                return (
                    <>
                        <div style={styles.header}>
                            <h1 style={styles.headerTitle}>{t('costs')}</h1>
                            <p style={styles.headerSubtitle}>{t('expensesSummary')}{numPersone > 1 ? ` ${t('multiplyFor')} ${numPersone} ${t('people')}` : ''}</p>
                        </div>
                        
                        <div style={styles.content}>
                            <div style={styles.dayCost}>
                                <p style={styles.dayCostLabel}>{t('tripTotal')}</p>
                                <p style={styles.dayCostValue}>{currency}{totalCosts.toFixed(2)}</p>
                            </div>

                            {budget > 0 && (
                                <div style={styles.budgetBar}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                                        <span style={{ fontSize: '14px', color: 'var(--text-secondary)' }}>{t('budget')}</span>
                                        <span style={{ fontSize: '14px', fontWeight: '600', color: budgetRemaining >= 0 ? 'var(--success)' : 'var(--danger)' }}>
                                            {budgetRemaining >= 0 ? `${currency}${budgetRemaining.toFixed(2)} ${t('remaining')}` : `${currency}${Math.abs(budgetRemaining).toFixed(2)} ${t('overBudget')}`}
                                        </span>
                                    </div>
                                    <div style={styles.budgetProgress}>
                                        <div style={{...styles.budgetProgressFill, width: `${budgetPercentage}%`, background: budgetPercentage > 100 ? 'var(--danger)' : budgetPercentage > 80 ? 'var(--warning)' : 'var(--success)'}} />
                                    </div>
                                    <div style={{ fontSize: '12px', color: 'var(--text-tertiary)', marginTop: '4px', textAlign: 'right' }}>
                                        {budgetPercentage.toFixed(0)}% di {currency}{budget.toFixed(2)}
                                    </div>
                                </div>
                            )}

                            <div style={styles.totalCard}>
                                {totalMezzo > 0 && (
                                    <div style={styles.totalRow}>
                                        <span style={styles.cardLabel}>üöó {t('transportsCost')}</span>
                                        <span style={styles.cardValue}>{currency}{totalMezzo.toFixed(2)}</span>
                                    </div>
                                )}
                                {totalPasto > 0 && (
                                    <div style={styles.totalRow}>
                                        <span style={styles.cardLabel}>üçΩÔ∏è {t('mealsCost')}</span>
                                        <span style={styles.cardValue}>{currency}{totalPasto.toFixed(2)}</span>
                                    </div>
                                )}
                                {totalHotel > 0 && (
                                    <div style={styles.totalRow}>
                                        <span style={styles.cardLabel}>üè® {t('hotelsCost')}</span>
                                        <span style={styles.cardValue}>{currency}{totalHotel.toFixed(2)}</span>
                                    </div>
                                )}
                                {totalAttivita > 0 && (
                                    <div style={styles.totalRow}>
                                        <span style={styles.cardLabel}>üéØ {t('activitiesCost')}</span>
                                        <span style={styles.cardValue}>{currency}{totalAttivita.toFixed(2)}</span>
                                    </div>
                                )}
                                {totalVari > 0 && (
                                    <div style={{ ...styles.totalRow, borderBottom: 'none' }}>
                                        <span style={styles.cardLabel}>üì¶ {t('miscCost')}</span>
                                        <span style={styles.cardValue}>{currency}{totalVari.toFixed(2)}</span>
                                    </div>
                                )}
                            </div>

                            {/* Advanced Statistics */}
                            {trips.length > 0 && dates.length > 0 && (
                                <div style={styles.totalCard}>
                                    <h3 style={{ ...styles.cardTitle, marginBottom: '16px' }}>
                                        üìä {t('statistics')}
                                    </h3>
                                    
                                    <div style={styles.totalRow}>
                                        <span style={styles.cardLabel}>üí∞ {t('avgPerDay')}</span>
                                        <span style={styles.cardValue}>{currency}{(totalCosts / dates.length).toFixed(2)}</span>
                                    </div>
                                    
                                    {(() => {
                                        const dayCosts = dates.map(date => ({
                                            date,
                                            cost: getDayCostWithMultiplier(groupedTrips[date])
                                        }));
                                        const mostExpensiveDay = dayCosts.reduce((max, day) => day.cost > max.cost ? day : max, dayCosts[0]);
                                        const cheapestDay = dayCosts.reduce((min, day) => day.cost < min.cost && day.cost > 0 ? day : min, dayCosts[0]);
                                        
                                        return (
                                            <>
                                                <div style={styles.totalRow}>
                                                    <span style={styles.cardLabel}>üìà {t('mostExpensiveDay')}</span>
                                                    <span style={styles.cardValue}>{mostExpensiveDay.date} ({currency}{mostExpensiveDay.cost.toFixed(2)})</span>
                                                </div>
                                                <div style={{ ...styles.totalRow, borderBottom: 'none' }}>
                                                    <span style={styles.cardLabel}>üìâ {t('cheapestDay')}</span>
                                                    <span style={styles.cardValue}>{cheapestDay.date} ({currency}{cheapestDay.cost.toFixed(2)})</span>
                                                </div>
                                            </>
                                        );
                                    })()}
                                </div>
                            )}

                            {/* Km per Transport Type */}
                            {trips.some(t => t.Mezzo && parseFloat(t.Distanza) > 0) && (
                                <div style={styles.totalCard}>
                                    <h3 style={{ ...styles.cardTitle, marginBottom: '16px' }}>
                                        üöó {t('kmPerTransport')}
                                    </h3>
                                    {(() => {
                                        const kmByTransport = {};
                                        trips.forEach(trip => {
                                            if (trip.Mezzo && trip.Distanza) {
                                                const mezzo = trip.Mezzo;
                                                kmByTransport[mezzo] = (kmByTransport[mezzo] || 0) + parseFloat(trip.Distanza);
                                            }
                                        });
                                        
                                        return Object.entries(kmByTransport).map(([mezzo, km], idx, arr) => (
                                            <div key={mezzo} style={{ ...styles.totalRow, borderBottom: idx === arr.length - 1 ? 'none' : '1px solid var(--separator)' }}>
                                                <span style={styles.cardLabel}>{getTransportIcon(mezzo)} {mezzo}</span>
                                                <span style={styles.cardValue}>{km.toFixed(1)} km</span>
                                            </div>
                                        ));
                                    })()}
                                </div>
                            )}

                            {costBreakdown.length > 0 && (
                                <div style={styles.chartContainer}>
                                    <h3 style={{ ...styles.cardTitle, marginBottom: '16px' }}>
                                        <Icon name="pieChart" size={20} />
                                        {t('byExpenseType')}
                                    </h3>
                                    {costBreakdown.map(item => (
                                        <div key={item.name} style={styles.chartBar}>
                                            <span style={styles.chartBarLabel}>{item.icon} {item.name}</span>
                                            <div style={styles.chartBarTrack}>
                                                <div style={{...styles.chartBarFill, width: `${(item.total / maxCost) * 100}%`, background: item.color}}>
                                                    {currency}{item.total.toFixed(0)}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            <h3 style={{ ...styles.cardTitle, marginBottom: '16px' }}>{t('byDay')}</h3>
                            {dates.map(date => {
                                const dayCost = getDayCostWithMultiplier(groupedTrips[date]);
                                const dayDistance = groupedTrips[date].reduce((acc, trip) => acc + (parseFloat(trip['Distanza']) || 0), 0);
                                return (
                                    <div key={date} style={styles.totalCard}>
                                        <div style={{ ...styles.totalRow, borderBottom: 'none' }}>
                                            <div>
                                                <span style={{ ...styles.cardLabel, fontSize: '15px', color: 'var(--text-primary)', display: 'block' }}>{date}</span>
                                                {dayDistance > 0 && (<span style={{ fontSize: '12px', color: 'var(--text-tertiary)' }}>{dayDistance.toFixed(1)} km</span>)}
                                            </div>
                                            <span style={{ ...styles.cardValue, fontWeight: '600' }}>{currency}{dayCost.toFixed(2)}</span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </>
                );
            };

            // Settings Page
            const SettingsPage = () => {
                const [localTitle, setLocalTitle] = useState(tripTitle);
                const [localNumPersone, setLocalNumPersone] = useState(numPersone.toString());
                const [localBudget, setLocalBudget] = useState(budget.toString());
                
                // Sync local states when parent states change
                useEffect(() => {
                    setLocalTitle(tripTitle);
                }, [tripTitle]);
                
                useEffect(() => {
                    setLocalNumPersone(numPersone.toString());
                }, [numPersone]);
                
                useEffect(() => {
                    setLocalBudget(budget.toString());
                }, [budget]);
                
                const handleTitleBlur = () => {
                    setTripTitle(localTitle);
                };

                const handleBudgetChange = (e) => {
                    setLocalBudget(e.target.value);
                };

                const handleBudgetBlur = () => {
                    const num = parseFloat(localBudget) || 0;
                    setBudget(num);
                    setLocalBudget(num.toString());
                };

                const handleNumPersoneBlur = () => {
                    const num = parseInt(localNumPersone) || 1;
                    setNumPersone(Math.max(1, num));
                    setLocalNumPersone(Math.max(1, num).toString());
                };

                const toggleMoltiplicatore = (field) => {
                    setMoltiplicatori(prev => ({
                        ...prev,
                        [field]: !prev[field]
                    }));
                };

                return (
                    <>
                        <div style={styles.header}>
                            <h1 style={styles.headerTitle}>{t('settings')}</h1>
                            <p style={styles.headerSubtitle}>{t('customizeApp')}</p>
                        </div>
                        
                        <div style={styles.content}>
                            <label style={styles.inputLabel}>{t('tripName')}</label>
                            <input 
                                style={styles.input} 
                                value={localTitle} 
                                onChange={e => setLocalTitle(e.target.value)} 
                                onBlur={handleTitleBlur}
                                placeholder={t('tripName')}
                            />

                            <label style={styles.inputLabel}>{t('totalBudget')} ({currency})</label>
                            <input 
                                style={styles.input} 
                                type="number" 
                                value={localBudget} 
                                onChange={handleBudgetChange} 
                                onBlur={handleBudgetBlur}
                                placeholder="0" 
                            />

                            <label style={styles.inputLabel}>{t('currency')}</label>
                            <select style={{ ...styles.input, cursor: 'pointer' }} value={currency} onChange={e => setCurrency(e.target.value)}>
                                {currencies.map(curr => (<option key={curr.symbol} value={curr.symbol}>{curr.symbol} - {curr.name}</option>))}
                            </select>

                            <div style={{ ...styles.totalCard, marginTop: '8px' }}>
                                <h3 style={{ ...styles.cardTitle, marginBottom: '16px' }}>üë• {t('multiPersonCalc')}</h3>
                                
                                <label style={styles.inputLabel}>{t('numPeople')}</label>
                                <input 
                                    style={{ ...styles.input, marginBottom: '16px' }} 
                                    type="number" 
                                    min="1"
                                    value={localNumPersone} 
                                    onChange={e => setLocalNumPersone(e.target.value)}
                                    onBlur={handleNumPersoneBlur}
                                />
                                
                                <label style={styles.inputLabel}>{t('multiplyFor')} {numPersone} {t('people')}:</label>
                                
                                {[
                                    { field: 'Costo Mezzo', icon: 'üöó', label: t('transports') },
                                    { field: 'Costo Pasto', icon: 'üçΩÔ∏è', label: t('meals') },
                                    { field: 'Costo Hotel', icon: 'üè®', label: t('hotels') },
                                    { field: 'Costo Attivit√†', icon: 'üéØ', label: t('activities') },
                                    { field: 'Costi Vari', icon: 'üì¶', label: t('misc') }
                                ].map(item => (
                                    <div key={item.field} style={{ ...styles.settingsItem, marginBottom: '8px', padding: '12px' }}>
                                        <span style={{ fontSize: '14px', color: 'var(--text-primary)' }}>{item.icon} {item.label}</span>
                                        <button
                                            style={{
                                                ...styles.toggle,
                                                background: moltiplicatori[item.field] ? 'var(--accent)' : 'var(--separator)',
                                                width: '44px',
                                                height: '26px'
                                            }}
                                            onClick={() => toggleMoltiplicatore(item.field)}
                                        >
                                            <div style={{
                                                ...styles.toggleThumb,
                                                width: '22px',
                                                height: '22px',
                                                left: moltiplicatori[item.field] ? '20px' : '2px'
                                            }} />
                                        </button>
                                    </div>
                                ))}
                            </div>

                            <label style={styles.inputLabel}>{t('themeColor')}</label>
                            <div style={styles.colorPicker}>
                                {ACCENT_COLORS.map(color => (
                                    <div key={color.id} style={{...styles.colorOption, background: color.color, ...(accentColor === color.id ? styles.colorOptionSelected : {})}} onClick={() => setAccentColor(color.id)}>
                                        {accentColor === color.id && <Icon name="check" size={16} />}
                                    </div>
                                ))}
                            </div>

                            <div style={styles.settingsItem}>
                                <span style={styles.settingsLabel}>{t('darkMode')}</span>
                                <button type="button" style={{...styles.toggle, background: darkMode ? 'var(--accent)' : 'var(--separator)'}} onClick={() => setDarkMode(!darkMode)}>
                                    <div style={{...styles.toggleThumb, left: darkMode ? '22px' : '2px'}} />
                                </button>
                            </div>

                            <label style={styles.inputLabel}>{t('language')}</label>
                            <select style={{ ...styles.input, cursor: 'pointer' }} value={language} onChange={e => setLanguage(e.target.value)}>
                                <option value="it">üáÆüáπ Italiano</option>
                                <option value="en">üá¨üáß English</option>
                            </select>

                            <input type="file" ref={fileInputRef} accept=".csv" onChange={handleImportCSV} style={{ display: 'none' }} />
                            
                            <button style={{ ...styles.button, ...styles.primaryButton }} onClick={() => fileInputRef.current?.click()}>
                                <Icon name="upload" size={20} />
                                {t('importCSV')}
                            </button>
                            
                            <button style={{ ...styles.button, ...styles.secondaryButton }} onClick={handleExportCSV} disabled={trips.length === 0}>
                                <Icon name="download" size={20} />
                                {t('exportCSV')}
                            </button>

                            {trips.length > 0 && (
                                <button style={{ ...styles.button, background: 'var(--danger)', color: 'white' }} onClick={() => { if (confirm(t('deleteConfirm'))) { setTrips([]); setCurrentDateIndex(0); }}}>
                                    <Icon name="trash" size={20} />
                                    {t('deleteAllData')}
                                </button>
                            )}

                            {/* Versione App */}
                            <div style={{ 
                                marginTop: '40px', 
                                paddingTop: '20px', 
                                borderTop: '1px solid var(--separator)',
                                textAlign: 'center'
                            }}>
                                <div style={{ 
                                    fontSize: '13px', 
                                    color: 'var(--text-tertiary)',
                                    marginBottom: '4px'
                                }}>
                                    {t('version')} {APP_VERSION}
                                </div>
                                <div style={{ 
                                    fontSize: '12px', 
                                    color: 'var(--text-tertiary)',
                                    opacity: 0.7
                                }}>
                                    {t('madeWith')}
                                </div>
                            </div>
                        </div>
                    </>
                );
            };

            // Map Page Component
            const MapPage = () => {
                const mapRef = useRef(null);
                const mapInstanceRef = useRef(null);
                const markersRef = useRef([]);
                const [selectedDay, setSelectedDay] = useState('all');

                // Get unique dates
                const dates = [...new Set(trips.map(t => t.Data))].sort((a, b) => {
                    const [dayA, monthA] = a.split('/').map(Number);
                    const [dayB, monthB] = b.split('/').map(Number);
                    if (monthA !== monthB) return monthA - monthB;
                    return dayA - dayB;
                });

                // Filter trips by selected day
                const filteredTrips = selectedDay === 'all' 
                    ? trips 
                    : trips.filter(t => t.Data === selectedDay);

                // Get coordinates from trips (using Meteo Luogo for geocoding)
                const [markers, setMarkers] = useState([]);

                useEffect(() => {
                    const geocodeLocations = async () => {
                        const uniqueLocations = [...new Set(filteredTrips.map(t => t['Meteo Luogo'] || t.Luogo).filter(Boolean))];
                        const newMarkers = [];

                        for (const location of uniqueLocations) {
                            try {
                                const response = await fetch(
                                    `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(location)}&count=1&language=${language}`
                                );
                                const data = await response.json();
                                if (data.results && data.results.length > 0) {
                                    const { latitude, longitude, name } = data.results[0];
                                    // Find all trips for this location
                                    const locationTrips = filteredTrips.filter(t => 
                                        (t['Meteo Luogo'] || t.Luogo) === location
                                    );
                                    newMarkers.push({
                                        lat: latitude,
                                        lng: longitude,
                                        name: name,
                                        trips: locationTrips
                                    });
                                }
                            } catch (e) {
                                console.log('Geocoding error for:', location);
                            }
                        }
                        setMarkers(newMarkers);
                    };

                    if (filteredTrips.length > 0) {
                        geocodeLocations();
                    }
                }, [filteredTrips, language]);

                // Initialize map
                useEffect(() => {
                    if (!mapRef.current || mapInstanceRef.current) return;

                    // Default center: Japan
                    mapInstanceRef.current = L.map(mapRef.current).setView([35.6762, 139.6503], 5);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(mapInstanceRef.current);

                    return () => {
                        if (mapInstanceRef.current) {
                            mapInstanceRef.current.remove();
                            mapInstanceRef.current = null;
                        }
                    };
                }, []);

                // Update markers
                useEffect(() => {
                    if (!mapInstanceRef.current) return;

                    // Clear existing markers
                    markersRef.current.forEach(m => m.remove());
                    markersRef.current = [];

                    if (markers.length === 0) return;

                    // Category colors
                    const categoryColors = {
                        'trasporti': '#007AFF',
                        'alloggio': '#5856D6',
                        'cibo': '#FF9500',
                        'shopping': '#FF2D55',
                        'attivita': '#34C759',
                        'altro': '#8E8E93'
                    };

                    // Add markers
                    const bounds = [];
                    markers.forEach(marker => {
                        const mainCategory = marker.trips[0]?.Categoria || 'altro';
                        const color = categoryColors[mainCategory] || categoryColors.altro;

                        const icon = L.divIcon({
                            className: 'custom-marker',
                            html: `<div style="
                                background: ${color};
                                width: 32px;
                                height: 32px;
                                border-radius: 50% 50% 50% 0;
                                transform: rotate(-45deg);
                                border: 3px solid white;
                                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            "><span style="transform: rotate(45deg); color: white; font-weight: bold; font-size: 12px;">${marker.trips.length}</span></div>`,
                            iconSize: [32, 32],
                            iconAnchor: [16, 32],
                            popupAnchor: [0, -32]
                        });

                        const popupContent = `
                            <div style="max-width: 200px;">
                                <strong style="font-size: 14px;">${marker.name}</strong>
                                <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                    ${marker.trips.length} ${marker.trips.length === 1 ? t('stage') : t('stages')}
                                </div>
                                <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 12px;">
                                    ${marker.trips.slice(0, 5).map(trip => `<li>${trip.Luogo || trip.Descrizione}</li>`).join('')}
                                    ${marker.trips.length > 5 ? `<li>... +${marker.trips.length - 5}</li>` : ''}
                                </ul>
                            </div>
                        `;

                        const m = L.marker([marker.lat, marker.lng], { icon })
                            .addTo(mapInstanceRef.current)
                            .bindPopup(popupContent);

                        markersRef.current.push(m);
                        bounds.push([marker.lat, marker.lng]);
                    });

                    // Fit bounds
                    if (bounds.length > 0) {
                        if (bounds.length === 1) {
                            mapInstanceRef.current.setView(bounds[0], 12);
                        } else {
                            mapInstanceRef.current.fitBounds(bounds, { padding: [50, 50] });
                        }
                    }
                }, [markers]);

                return (
                    <>
                        <div style={styles.header}>
                            <h1 style={styles.headerTitle}>{t('mapTitle')}</h1>
                            <p style={{ ...styles.headerSubtitle, marginTop: '4px' }}>
                                {markers.length} {language === 'it' ? 'localit√†' : 'locations'}
                            </p>
                        </div>

                        <div style={{ ...styles.content, padding: '0', paddingBottom: '100px' }}>
                            {/* Day filter */}
                            <div style={{ padding: '12px 20px', background: 'var(--bg-secondary)', borderBottom: '1px solid var(--separator)' }}>
                                <div style={{ display: 'flex', gap: '8px', overflowX: 'auto', scrollbarWidth: 'none' }}>
                                    <button
                                        style={{
                                            ...styles.filterChip,
                                            ...(selectedDay === 'all' ? styles.filterChipActive : {})
                                        }}
                                        onClick={() => setSelectedDay('all')}
                                    >
                                        {t('allDays')}
                                    </button>
                                    {dates.map(date => (
                                        <button
                                            key={date}
                                            style={{
                                                ...styles.filterChip,
                                                ...(selectedDay === date ? styles.filterChipActive : {})
                                            }}
                                            onClick={() => setSelectedDay(date)}
                                        >
                                            {date}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Map container */}
                            {trips.length === 0 ? (
                                <div style={styles.noResults}>
                                    <Icon name="mapPin" size={48} />
                                    <h3 style={{ margin: '16px 0 8px' }}>{t('noMapData')}</h3>
                                    <p>{t('addStagesForMap')}</p>
                                </div>
                            ) : (
                                <div 
                                    ref={mapRef} 
                                    style={{ 
                                        width: '100%', 
                                        height: 'calc(100vh - 200px)',
                                        minHeight: '400px'
                                    }} 
                                />
                            )}

                            {/* Legend */}
                            <div style={{ 
                                padding: '12px 20px', 
                                background: 'var(--bg-secondary)',
                                borderTop: '1px solid var(--separator)',
                                display: 'flex',
                                flexWrap: 'wrap',
                                gap: '12px',
                                fontSize: '11px'
                            }}>
                                {[
                                    { cat: 'trasporti', color: '#007AFF', label: 'üöå ' + t('transports') },
                                    { cat: 'alloggio', color: '#5856D6', label: 'üè® ' + t('hotels') },
                                    { cat: 'cibo', color: '#FF9500', label: 'üçΩÔ∏è ' + t('meals') },
                                    { cat: 'shopping', color: '#FF2D55', label: 'üõçÔ∏è Shopping' },
                                    { cat: 'attivita', color: '#34C759', label: 'üéØ ' + t('activities') },
                                ].map(item => (
                                    <div key={item.cat} style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                        <div style={{ width: '12px', height: '12px', borderRadius: '50%', background: item.color }} />
                                        <span>{item.label}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </>
                );
            };

            return (
                <div style={styles.container}>
                    {currentPage === 'home' && <HomePage />}
                    {currentPage === 'costs' && <CostsPage />}
                    {currentPage === 'map' && <MapPage />}
                    {currentPage === 'settings' && <SettingsPage />}

                    {editingTrip && (
                        <TripModal trip={editingTrip.data} onSave={(data) => handleSaveTrip(data, editingTrip.index)} onClose={() => setEditingTrip(null)} isNew={false} />
                    )}

                    {showAddModal && (
                        <TripModal trip={null} onSave={(data) => handleSaveTrip(data)} onClose={() => setShowAddModal(false)} isNew={true} />
                    )}

                    <div style={styles.tabBar}>
                        <button style={{...styles.tabButton, ...(currentPage === 'home' ? styles.tabButtonActive : {})}} onClick={() => setCurrentPage('home')}>
                            <Icon name="home" size={24} />
                            {t('trip')}
                        </button>
                        <button style={{...styles.tabButton, ...(currentPage === 'map' ? styles.tabButtonActive : {})}} onClick={() => setCurrentPage('map')}>
                            <Icon name="mapPin" size={24} />
                            {t('mapTab')}
                        </button>
                        <button style={{...styles.tabButton, ...(currentPage === 'costs' ? styles.tabButtonActive : {})}} onClick={() => setCurrentPage('costs')}>
                            <Icon name="wallet" size={24} />
                            {t('costs')}
                        </button>
                        <button style={{...styles.tabButton, ...(currentPage === 'settings' ? styles.tabButtonActive : {})}} onClick={() => setCurrentPage('settings')}>
                            <Icon name="settings" size={24} />
                            {t('settings')}
                        </button>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then((registration) => {
                    console.log('SW registered: ', registration);
                }).catch((registrationError) => {
                    console.log('SW registration failed: ', registrationError);
                });
            });
        }
    </script>
</body>
</html>
